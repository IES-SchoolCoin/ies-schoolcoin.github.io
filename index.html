<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SCHOOLCOIN - Transacciones en Mi cuenta</title>

  <style>
    :root{--bg:#f7d54a;--top:#000;--btn:#8b5e3c;--text:#222;}
    html,body{height:100%;margin:0;font-family:Inter,Arial,sans-serif;background:var(--bg);color:var(--text);}
    .contenedor{width:100%;max-width:920px;margin:0 auto;padding:16px;box-sizing:border-box;}
    .top-bar{background:var(--top);color:#fff;padding:10px;font-weight:700;text-align:center;border-radius:8px;}
    .header{margin-top:14px;font-size:22px;font-weight:800;text-align:center;}
    .row{display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap;}
    .col{flex:1;min-width:300px;}
    .coin-logo{width:72px;height:72px;margin:8px auto;}
    .coin-logo img{width:100%;height:100%;object-fit:contain;display:block;}
    .valor-actual{font-size:26px;font-weight:800;margin-top:8px;text-align:center;}
    .meta-line{display:flex;justify-content:space-between;align-items:center;gap:8px;margin-top:6px;font-size:13px;color:#333;}
    .chart-wrap{width:100%;margin-top:14px;background:transparent;border-radius:12px;padding:6px;}
    canvas{width:100% !important;height:300px !important;display:block;}
    .botones{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:16px;}
    .boton{background:var(--btn);color:#fff;padding:12px;border-radius:10px;font-weight:700;text-align:center;cursor:pointer;user-select:none;}
    .controls{display:flex;gap:8px;margin-top:10px;justify-content:center;}
    .control-btn{background:#fff;border:1px solid #ccc;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:600;}
    .info-box{margin-top:12px;background:rgba(0,0,0,0.06);padding:10px;border-radius:8px;font-size:13px;}
    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:9999;}
    .modal{background:#fff;color:#111;border-radius:12px;padding:16px;max-width:720px;width:94%;box-sizing:border-box;max-height:80vh;overflow:auto;}
    .modal h3{margin:0 0 8px 0;font-size:18px;}
    .modal input, .modal select, .modal textarea{width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #ddd;box-sizing:border-box;}
    .modal .row{display:flex;gap:8px;margin-top:12px;}
    .modal .btn{flex:1;padding:10px;border-radius:8px;border:0;cursor:pointer;font-weight:700;}
    .btn-primary{background:#0b8a3e;color:#fff;}
    .btn-ghost{background:#f3f3f3;color:#333;border:1px solid #ddd;}
    .tx-list{list-style:none;padding:0;margin:0;}
    .tx-item{padding:10px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;gap:12px;align-items:center;}
    .tx-left{display:flex;flex-direction:column;gap:4px;}
    .tx-meta{font-size:12px;color:#666;}
    .tx-amount{font-weight:800;color:#0b8a3e;}
    .pager{display:flex;gap:8px;justify-content:center;margin-top:12px;}
    @media (max-width:900px){ .contenedor{max-width:420px;} canvas{height:260px !important;} .botones{grid-template-columns:1fr 1fr;} }
  </style>
</head>
<body>
  <div class="contenedor">
    <div class="top-bar">SCHOOLCOIN</div>
    <div class="header">IES-SchoolCoin</div>

    <div class="row" style="align-items:center;">
      <div style="flex:0 0 120px; text-align:center;">
        <div class="coin-logo"><img src="LOGO.png" alt="Logo"></div>
        <div class="valor-actual" id="valorActual">0.00 €</div>
      </div>

      <div class="col">
        <div style="font-weight:700;margin-bottom:6px;">Gráfica principal</div>
        <div class="chart-wrap"><canvas id="graficaMain"></canvas></div>
      </div>

      <div class="col">
        <div style="font-weight:700;margin-bottom:6px;">Gráfica comparada</div>
        <div class="chart-wrap"><canvas id="graficaCompare"></canvas></div>
      </div>
    </div>

    <div class="meta-line" style="margin-top:8px;">
      <div id="trendText">—</div>
      <div id="timestamp">—</div>
    </div>

    <div class="botones" style="margin-top:14px;">
      <div class="boton" id="btnEnviar">Enviar</div>
      <div class="boton" id="btnIngresos">Ingresos</div>
      <div class="boton" id="btnGastos">Gastos</div>
      <div class="boton" id="btnCuenta">Mi cuenta</div>
    </div>

    <div class="controls">
      <button class="control-btn" id="pauseBtn">Pausar actualizaciones</button>
      <button class="control-btn" id="addSample">Añadir valor ahora</button>
    </div>

    <div class="info-box" id="infoBox">Toca o haz clic en un punto para ver su fecha, hora y valor. Las dos gráficas están sincronizadas.</div>
  </div>

  <!-- Chart.js + adaptador de fechas -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/dist/date-fns.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

  <script>
    // CONFIG
    const UPDATE_INTERVAL_MS = 5000;
    const PRESET_POINTS = 600;
    const BASE = 0.175;
    const MIN = 0.15;
    const MAX = 0.20;

    // UTIL
    function clamp(v,a,b){return Math.max(a,Math.min(b,v));}
    function formatMoney(v){return Number(v).toFixed(2)+' €';}
    function formatDate(d){return d.toLocaleString('es-ES',{year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'});}

    function nextValue(prev){
      const meanReversion = (BASE - prev) * 0.08;
      const noise = (Math.random() - 0.5) * 0.006;
      return Number(clamp(prev + meanReversion + noise, MIN, MAX).toFixed(4));
    }

    // GENERAR SERIE BASE (determinista timestamps)
    function generateInitialSeries(){
      const labels = [];
      const data = [];
      const nowAligned = Math.floor(Date.now() / UPDATE_INTERVAL_MS) * UPDATE_INTERVAL_MS;
      const start = nowAligned - (PRESET_POINTS - 1) * UPDATE_INTERVAL_MS;
      let val = BASE + (Math.random() - 0.5) * 0.01;
      for(let i=0;i<PRESET_POINTS;i++){
        labels.push(new Date(start + i * UPDATE_INTERVAL_MS));
        val = nextValue(val);
        data.push(val);
      }
      return {labels,data};
    }

    // Datos maestros
    const master = generateInitialSeries();
    const masterLabels = master.labels.slice();
    const masterValues = master.data.slice();

    // Generar transacciones a partir del master (una por punto, con variación)
    // Cada transacción: {txid, from, to, amount, timestamp}
    function randomHex(len=8){
      const chars = '0123456789abcdef';
      let s = '';
      for(let i=0;i<len;i++) s += chars[Math.floor(Math.random()*chars.length)];
      return s;
    }

    // Generar lista de cuentas simuladas
    const ACCOUNTS = [];
    for(let i=1;i<=20;i++) ACCOUNTS.push('user' + String(i).padStart(2,'0'));

    function generateTransactionsFromMaster(){
      const txs = [];
      for(let i=0;i<masterLabels.length;i++){
        // probabilidad de que haya 0..2 transacciones por punto
        const count = Math.random() < 0.6 ? 1 : (Math.random() < 0.2 ? 2 : 0);
        for(let k=0;k<count;k++){
          const from = ACCOUNTS[(i + k) % ACCOUNTS.length];
          const to = ACCOUNTS[(i + k + 3) % ACCOUNTS.length];
          // amount relativo al precio y algo aleatorio
          const baseAmount = 1 + Math.abs(masterValues[i] - BASE) * 100; // escala
          const amount = Number((baseAmount * (0.5 + Math.random()*2)).toFixed(4));
          txs.push({
            txid: randomHex(12),
            from,
            to,
            amount,
            timestamp: new Date(masterLabels[i]).toISOString(), // ISO for consistency
            index: i // índice en la serie para enlazar con la gráfica
          });
        }
      }
      // ordenar por timestamp (ya lo están, pero por si acaso)
      txs.sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
      return txs;
    }

    const TRANSACTIONS = generateTransactionsFromMaster();

    // Crear dos series derivadas: main y compare (muy parecidas)
    function deriveSeriesFromMaster(jitterScale = 0.0006){
      const labels = masterLabels.slice();
      const data = masterValues.map(v => {
        const jitter = (Math.random() - 0.5) * jitterScale;
        return Number(clamp(v + jitter, MIN, MAX).toFixed(4));
      });
      return {labels, data};
    }

    let mainSeries = deriveSeriesFromMaster(0.0006);
    let compareSeries = deriveSeriesFromMaster(0.0010);

    // UI refs
    const valorActualEl = document.getElementById('valorActual');
    const timestampEl = document.getElementById('timestamp');
    const trendTextEl = document.getElementById('trendText');
    const infoBox = document.getElementById('infoBox');

    function updateMainDisplay(value,date){
      valorActualEl.textContent = formatMoney(value);
      timestampEl.textContent = formatDate(date);
      const prev = mainSeries.data.length > 1 ? mainSeries.data[mainSeries.data.length - 2] : value;
      const diff = value - prev;
      const arrow = diff > 0 ? '▲' : (diff < 0 ? '▼' : '—');
      const pct = prev ? ((diff / prev) * 100).toFixed(2) + '%' : '';
      trendTextEl.textContent = arrow + ' ' + pct;
    }

    // Crear charts
    const ctxMain = document.getElementById('graficaMain').getContext('2d');
    const ctxCompare = document.getElementById('graficaCompare').getContext('2d');

    function createChart(ctx, labels, data, color){
      return new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'SCHOOLCOIN',
            data: data,
            borderColor: color,
            backgroundColor: color === '#0b8a3e' ? 'rgba(11,138,62,0.12)' : 'rgba(8,120,200,0.08)',
            pointRadius: (ctx) => ctx.active ? 6 : 0,
            pointHoverRadius: 6,
            pointHitRadius: 12,
            tension: 0.25,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: { duration: 0 },
          interaction: { mode: 'nearest', intersect: false },
          plugins: {
            legend: { display: false },
            tooltip: {
              enabled: true,
              callbacks: {
                label: function(c){
                  const v = Number(c.parsed.y).toFixed(4);
                  const date = c.label instanceof Date ? formatDate(c.label) : c.label;
                  return ` ${v} € — ${date}`;
                }
              }
            }
          },
          scales: {
            x: {
              type: 'time',
              time: { unit: 'second', displayFormats: { second: 'HH:mm:ss' } },
              grid: { display: false },
              ticks: { color: '#333', maxRotation: 0, autoSkip: true, maxTicksLimit: 8 }
            },
            y: {
              beginAtZero: false,
              suggestedMin: MIN - 0.01,
              suggestedMax: MAX + 0.01,
              grid: { display: false },
              ticks: { callback: v => Number(v).toFixed(2) + ' €', color: '#333' }
            }
          }
        }
      });
    }

    const chartMain = createChart(ctxMain, mainSeries.labels, mainSeries.data, '#0b8a3e');
    const chartCompare = createChart(ctxCompare, compareSeries.labels, compareSeries.data, '#0878c8');

    // Selección sincronizada
    function clearAllActive(){
      try{ chartMain.setActiveElements([]); chartMain.tooltip.setActiveElements([], {x:0,y:0}); chartMain.update('none'); }catch(e){}
      try{ chartCompare.setActiveElements([]); chartCompare.tooltip.setActiveElements([], {x:0,y:0}); chartCompare.update('none'); }catch(e){}
    }

    function highlightBoth(index){
      if(index == null) return;
      clearAllActive();
      const activeMain = [{datasetIndex:0, index}];
      chartMain.setActiveElements(activeMain);
      const xMain = chartMain.scales.x.getPixelForValue(chartMain.data.labels[index]);
      const yMain = chartMain.scales.y.getPixelForValue(chartMain.data.datasets[0].data[index]);
      chartMain.tooltip.setActiveElements(activeMain, {x:xMain,y:yMain});
      chartMain.update('none');

      const activeComp = [{datasetIndex:0, index}];
      chartCompare.setActiveElements(activeComp);
      const xComp = chartCompare.scales.x.getPixelForValue(chartCompare.data.labels[index]);
      const yComp = chartCompare.scales.y.getPixelForValue(chartCompare.data.datasets[0].data[index]);
      chartCompare.tooltip.setActiveElements(activeComp, {x:xComp,y:yComp});
      chartCompare.update('none');

      const val = chartMain.data.datasets[0].data[index];
      const lab = chartMain.data.labels[index];
      infoBox.textContent = `Punto: ${Number(val).toFixed(4)} € — ${formatDate(new Date(lab))}`;
    }

    // Interacciones
    const canvasMain = document.getElementById('graficaMain');
    const canvasCompare = document.getElementById('graficaCompare');

    function handleSelectionFromChart(chartRef, evtOrSim){
      const pts = chartRef.getElementsAtEventForMode(evtOrSim, 'nearest', {intersect: true}, true);
      if(pts.length) highlightBoth(pts[0].index);
      else {
        const pts2 = chartRef.getElementsAtEventForMode(evtOrSim, 'nearest', {intersect: false}, true);
        if(pts2.length) highlightBoth(pts2[0].index);
      }
    }

    canvasMain.addEventListener('mousemove', (e) => handleSelectionFromChart(chartMain, e));
    canvasCompare.addEventListener('mousemove', (e) => handleSelectionFromChart(chartCompare, e));
    canvasMain.addEventListener('click', (e) => handleSelectionFromChart(chartMain, e));
    canvasCompare.addEventListener('click', (e) => handleSelectionFromChart(chartCompare, e));
    canvasMain.addEventListener('touchend', (e) => { if(e.changedTouches && e.changedTouches.length){ const t = e.changedTouches[0]; handleSelectionFromChart(chartMain, {clientX: t.clientX, clientY: t.clientY}); } }, {passive:true});
    canvasCompare.addEventListener('touchend', (e) => { if(e.changedTouches && e.changedTouches.length){ const t = e.changedTouches[0]; handleSelectionFromChart(chartCompare, {clientX: t.clientX, clientY: t.clientY}); } }, {passive:true});
    canvasMain.addEventListener('mouseleave', () => { clearAllActive(); infoBox.textContent = 'Toca o haz clic en un punto para ver su fecha, hora y valor.'; });
    canvasCompare.addEventListener('mouseleave', () => { clearAllActive(); infoBox.textContent = 'Toca o haz clic en un punto para ver su fecha, hora y valor.'; });

    // Actualizaciones deterministas: añadir punto maestro y derivar
    let paused = false;
    let updateTimer = null;

    function pushNewMasterPoint(nextDate, newMasterVal){
      clearAllActive();
      masterLabels.push(nextDate);
      masterValues.push(newMasterVal);
      if(masterLabels.length > PRESET_POINTS){ masterLabels.shift(); masterValues.shift(); }

      // generar transacciones nuevas para este punto (0..2)
      const count = Math.random() < 0.6 ? 1 : (Math.random() < 0.2 ? 2 : 0);
      for(let k=0;k<count;k++){
        const from = ACCOUNTS[(masterLabels.length + k) % ACCOUNTS.length];
        const to = ACCOUNTS[(masterLabels.length + k + 3) % ACCOUNTS.length];
        const baseAmount = 1 + Math.abs(newMasterVal - BASE) * 100;
        const amount = Number((baseAmount * (0.5 + Math.random()*2)).toFixed(4));
        TRANSACTIONS.push({
          txid: randomHex(12),
          from, to, amount,
          timestamp: new Date(nextDate).toISOString(),
          index: masterLabels.length - 1
        });
      }

      // derivar y añadir a charts
      const jitterMain = (Math.random() - 0.5) * 0.0006;
      const jitterComp = (Math.random() - 0.5) * 0.0010;
      const mainVal = Number(clamp(newMasterVal + jitterMain, MIN, MAX).toFixed(4));
      const compVal = Number(clamp(newMasterVal + jitterComp, MIN, MAX).toFixed(4));

      chartMain.data.labels.push(nextDate);
      chartMain.data.datasets[0].data.push(mainVal);
      if(chartMain.data.labels.length > PRESET_POINTS){ chartMain.data.labels.shift(); chartMain.data.datasets[0].data.shift(); }
      chartMain.update('none');

      chartCompare.data.labels.push(nextDate);
      chartCompare.data.datasets[0].data.push(compVal);
      if(chartCompare.data.labels.length > PRESET_POINTS){ chartCompare.data.labels.shift(); chartCompare.data.datasets[0].data.shift(); }
      chartCompare.update('none');

      setTimeout(() => clearAllActive(), 20);

      mainSeries.labels = chartMain.data.labels.slice();
      mainSeries.data = chartMain.data.datasets[0].data.slice();
      compareSeries.labels = chartCompare.data.labels.slice();
      compareSeries.data = chartCompare.data.datasets[0].data.slice();

      updateMainDisplay(mainVal, nextDate);
    }

    function scheduleNextUpdate(){
      if(updateTimer) clearInterval(updateTimer);
      updateTimer = setInterval(() => {
        if(paused) return;
        const lastLabel = masterLabels[masterLabels.length - 1];
        const lastTime = (lastLabel instanceof Date) ? lastLabel.getTime() : new Date(lastLabel).getTime();
        const nextTime = new Date(lastTime + UPDATE_INTERVAL_MS);
        const prev = masterValues[masterValues.length - 1];
        const nv = nextValue(prev);
        pushNewMasterPoint(nextTime, nv);
      }, UPDATE_INTERVAL_MS);
    }

    scheduleNextUpdate();
    updateMainDisplay(mainSeries.data[mainSeries.data.length - 1], new Date(mainSeries.labels[mainSeries.labels.length - 1]));

    // MODAL helper
    function openModal(htmlContent){
      const bd = document.createElement('div');
      bd.className = 'modal-backdrop';
      bd.innerHTML = `<div class="modal">${htmlContent}</div>`;
      document.body.appendChild(bd);
      bd.addEventListener('click', (e) => { if(e.target === bd) bd.remove(); });
      return bd;
    }
    function closeModal(bd){ if(bd && bd.remove) bd.remove(); }

    // BOTONES: Enviar / Ingresos / Gastos (igual que antes)
    document.getElementById('btnEnviar').addEventListener('click', () => {
      const html = `<h3>Enviar SCHOOLCOIN</h3><label>Destinatario</label><input id="m_dest" placeholder="Dirección o usuario"><label>Cantidad</label><input id="m_amt" type="number" step="0.0001" placeholder="0.01"><div class="row"><button class="btn btn-ghost" id="m_cancel">Cancelar</button><button class="btn btn-primary" id="m_send">Enviar</button></div>`;
      const bd = openModal(html);
      bd.querySelector('#m_cancel').addEventListener('click', () => closeModal(bd));
      bd.querySelector('#m_send').addEventListener('click', () => {
        const dest = bd.querySelector('#m_dest').value || 'desconocido';
        const amt = parseFloat(bd.querySelector('#m_amt').value) || 0;
        bd.querySelector('.modal').innerHTML = `<h3>Enviado</h3><p>Enviado ${amt.toFixed(4)} SCHOOLCOIN a ${dest}.</p><div class="row"><button class="btn btn-primary" id="m_ok">Aceptar</button></div>`;
        bd.querySelector('#m_ok').addEventListener('click', () => closeModal(bd));
      });
    });

    document.getElementById('btnIngresos').addEventListener('click', () => {
      const html = `<h3>Registrar ingreso</h3><label>Cantidad</label><input id="i_amt" type="number" step="0.01" placeholder="10.00"><div class="row"><button class="btn btn-ghost" id="i_cancel">Cancelar</button><button class="btn btn-primary" id="i_ok">Confirmar</button></div>`;
      const bd = openModal(html);
      bd.querySelector('#i_cancel').addEventListener('click', () => closeModal(bd));
      bd.querySelector('#i_ok').addEventListener('click', () => {
        const amt = parseFloat(bd.querySelector('#i_amt').value) || 0;
        const lastMaster = masterValues[masterValues.length - 1];
        const delta = clamp(amt * 0.00005, 0, 0.005);
        const nv = clamp(lastMaster + delta + (Math.random()-0.5)*0.0005, MIN, MAX);
        const lastLabel = masterLabels[masterLabels.length - 1];
        const nextTime = new Date(((lastLabel instanceof Date) ? lastLabel.getTime() : new Date(lastLabel).getTime()) + UPDATE_INTERVAL_MS);
        pushNewMasterPoint(nextTime, Number(nv.toFixed(4)));
        bd.querySelector('.modal').innerHTML = `<h3>Ingreso registrado</h3><p>+${amt.toFixed(2)} — precio ajustado.</p><div class="row"><button class="btn btn-primary" id="i_done">Aceptar</button></div>`;
        bd.querySelector('#i_done').addEventListener('click', () => closeModal(bd));
      });
    });

    document.getElementById('btnGastos').addEventListener('click', () => {
      const html = `<h3>Registrar gasto</h3><label>Cantidad</label><input id="g_amt" type="number" step="0.01" placeholder="5.00"><div class="row"><button class="btn btn-ghost" id="g_cancel">Cancelar</button><button class="btn btn-primary" id="g_ok">Confirmar</button></div>`;
      const bd = openModal(html);
      bd.querySelector('#g_cancel').addEventListener('click', () => closeModal(bd));
      bd.querySelector('#g_ok').addEventListener('click', () => {
        const amt = parseFloat(bd.querySelector('#g_amt').value) || 0;
        const lastMaster = masterValues[masterValues.length - 1];
        const delta = clamp(amt * 0.00005, 0, 0.005);
        const nv = clamp(lastMaster - delta + (Math.random()-0.5)*0.0005, MIN, MAX);
        const lastLabel = masterLabels[masterLabels.length - 1];
        const nextTime = new Date(((lastLabel instanceof Date) ? lastLabel.getTime() : new Date(lastLabel).getTime()) + UPDATE_INTERVAL_MS);
        pushNewMasterPoint(nextTime, Number(nv.toFixed(4)));
        bd.querySelector('.modal').innerHTML = `<h3>Gasto registrado</h3><p>-${amt.toFixed(2)} — precio ajustado.</p><div class="row"><button class="btn btn-primary" id="g_done">Aceptar</button></div>`;
        bd.querySelector('#g_done').addEventListener('click', () => closeModal(bd));
      });
    });

    // MI CUENTA: mostrar transacciones (paginadas)
    document.getElementById('btnCuenta').addEventListener('click', () => {
      const PAGE_SIZE = 12;
      let page = 0;
      function renderPage(p){
        const start = p * PAGE_SIZE;
        const slice = TRANSACTIONS.slice().reverse().slice(start, start + PAGE_SIZE); // mostrar recientes primero
        let listHtml = '<ul class="tx-list">';
        slice.forEach(tx => {
          listHtml += `<li class="tx-item" data-index="${tx.index}" data-txid="${tx.txid}">
            <div class="tx-left">
              <div><strong>${tx.txid}</strong></div>
              <div class="tx-meta">${new Date(tx.timestamp).toLocaleString('es-ES')} · ${tx.from} → ${tx.to}</div>
            </div>
            <div class="tx-amount">${Number(tx.amount).toFixed(4)} SC</div>
          </li>`;
        });
        listHtml += '</ul>';
        // pager
        const totalPages = Math.ceil(TRANSACTIONS.length / PAGE_SIZE);
        const pager = `<div class="pager">
          <button class="btn-ghost" id="prevPage" ${page===0?'disabled':''}>Anterior</button>
          <div style="align-self:center">Página ${page+1} / ${totalPages}</div>
          <button class="btn-ghost" id="nextPage" ${page+1>=totalPages?'disabled':''}>Siguiente</button>
        </div>`;

        const html = `<h3>Mi cuenta — Transacciones</h3>
          <p><strong>Total transacciones:</strong> ${TRANSACTIONS.length}</p>
          ${listHtml}
          ${pager}
          <div class="row" style="margin-top:12px;"><button class="btn btn-primary" id="closeTx">Cerrar</button></div>`;

        return html;
      }

      const bd = openModal(renderPage(page));

      // delegación de eventos dentro del modal
      bd.addEventListener('click', (e) => {
        // cerrar
        if(e.target && e.target.id === 'closeTx') { bd.remove(); return; }
        // pager
        if(e.target && e.target.id === 'prevPage' && page>0){
          page--; bd.querySelector('.modal').innerHTML = renderPage(page); return;
        }
        if(e.target && e.target.id === 'nextPage' && (page+1)*PAGE_SIZE < TRANSACTIONS.length){
          page++; bd.querySelector('.modal').innerHTML = renderPage(page); return;
        }
        // click en transacción: mostrar detalle y centrar gráficas en ese índice
        const li = e.target.closest('.tx-item');
        if(li){
          const txid = li.getAttribute('data-txid');
          const tx = TRANSACTIONS.find(t => t.txid === txid);
          if(tx){
            // mostrar detalle
            bd.querySelector('.modal').innerHTML = `<h3>Transacción ${tx.txid}</h3>
              <p><strong>De:</strong> ${tx.from}</p>
              <p><strong>A:</strong> ${tx.to}</p>
              <p><strong>Cantidad:</strong> ${Number(tx.amount).toFixed(4)} SC</p>
              <p><strong>Fecha:</strong> ${new Date(tx.timestamp).toLocaleString('es-ES')}</p>
              <div class="row"><button class="btn btn-ghost" id="tx_back">Volver</button><button class="btn btn-primary" id="tx_focus">Ver en gráfica</button></div>`;
            // volver o centrar
            bd.querySelector('#tx_back').addEventListener('click', () => { bd.querySelector('.modal').innerHTML = renderPage(page); });
            bd.querySelector('#tx_focus').addEventListener('click', () => {
              // centrar ambas gráficas en el índice tx.index
              highlightBoth(tx.index);
            });
          }
        }
      });
    });

    // Pause / add sample
    document.getElementById('pauseBtn').addEventListener('click', () => {
      paused = !paused;
      document.getElementById('pauseBtn').textContent = paused ? 'Reanudar actualizaciones' : 'Pausar actualizaciones';
    });

    document.getElementById('addSample').addEventListener('click', () => {
      const lastLabel = masterLabels[masterLabels.length - 1];
      const lastTime = (lastLabel instanceof Date) ? lastLabel.getTime() : new Date(lastLabel).getTime();
      const nextTime = new Date(lastTime + UPDATE_INTERVAL_MS);
      const prev = masterValues[masterValues.length - 1];
      const nv = nextValue(prev);
      pushNewMasterPoint(nextTime, nv);
    });

    // Forzar render inicial
    window.addEventListener('load', () => { setTimeout(()=>{ chartMain.resize(); chartCompare.resize(); }, 100); });
  </script>
</body>
</html>