<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SCHOOLCOIN - App completa</title>

  <style>
    :root{
      --app-bg: #f7d54a;
      --accent: #0b8a3e;
      --muted: #666;
      --card-bg: #fff;
      --danger: #c62828;
      --radius: 12px;
      --shadow: 0 6px 18px rgba(0,0,0,0.08);
      --text: #222;
    }
    html,body{height:100%;margin:0;font-family:Inter,Arial,sans-serif;background:var(--app-bg);color:var(--text);}
    .contenedor{width:100%;max-width:920px;margin:0 auto;padding:16px;box-sizing:border-box;}
    .top-bar{background:#000;color:#fff;padding:10px;font-weight:700;text-align:center;border-radius:8px;}
    .header{margin-top:14px;font-size:22px;font-weight:800;text-align:center;}
    .row{display:flex;gap:16px;align-items:flex-start;flex-wrap:wrap;}
    .col{flex:1;min-width:300px;}
    .chart-wrap{margin-top:14px;border-radius:12px;padding:6px;background:transparent;}
    canvas{width:100% !important;height:320px !important;display:block;border-radius:8px;background:transparent;}
    .botones{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:12px;}
    .boton{background:var(--accent);color:#fff;padding:12px;border-radius:10px;font-weight:700;text-align:center;cursor:pointer;user-select:none;box-shadow:var(--shadow);border:0;}
    .info-box{margin-top:12px;background:rgba(0,0,0,0.06);padding:10px;border-radius:8px;font-size:13px;}
    .controls{display:flex;gap:8px;margin-top:10px;align-items:center;}
    .control-btn{background:#fff;border:1px solid #ccc;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:600;}
    .vol-control{margin-top:12px;background:rgba(255,255,255,0.9);padding:10px;border-radius:8px;font-size:13px;}
    .vol-row{display:flex;gap:8px;align-items:center;margin-top:6px;}
    .vol-row label{width:90px;font-weight:700;}
    .vol-row input[type="range"]{flex:1;}
    /* Modal y lista con tema de la app */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;}
    .modal{background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.95));color:var(--text);border-radius:16px;padding:14px;max-width:720px;width:100%;box-sizing:border-box;max-height:86vh;overflow:auto;box-shadow:var(--shadow);}
    .modal h3{margin:0 0 8px 0;font-size:18px;}
    .filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;}
    .filter-btn{padding:8px 10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:transparent;cursor:pointer;font-weight:700;color:var(--text);}
    .filter-active{background:var(--accent);color:#fff;border-color:var(--accent);}
    .tx-list{display:flex;flex-direction:column;gap:10px;padding:0;margin:0;}
    .tx-card{background:var(--card-bg);border-radius:12px;padding:10px;display:flex;justify-content:space-between;align-items:center;box-shadow:var(--shadow);cursor:pointer;border:1px solid rgba(0,0,0,0.04);}
    .tx-left{display:flex;flex-direction:column;gap:6px;min-width:0;}
    .tx-id{font-weight:800;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px;}
    .tx-meta{font-size:12px;color:var(--muted);display:flex;gap:8px;align-items:center;}
    .tx-amount{font-weight:900;color:var(--accent);min-width:120px;text-align:right;}
    .tx-type{font-size:11px;padding:4px 8px;border-radius:999px;background:rgba(11,138,62,0.08);color:var(--accent);font-weight:800;}
    .tx-type.gasto{background:rgba(198,40,40,0.08);color:var(--danger);}
    .tx-detail{margin-top:10px;background:linear-gradient(180deg,#fff,#fafafa);padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.04);font-size:13px;}
    .row-actions{display:flex;gap:8px;align-items:center;}
    .btn-small{padding:8px 10px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer;font-weight:700;}
    .muted{color:var(--muted);font-size:13px;}
    .empty{padding:18px;text-align:center;color:var(--muted);background:rgba(255,255,255,0.6);border-radius:12px;}
    @media (max-width:900px){ .contenedor{max-width:420px;} canvas{height:260px !important;} .botones{grid-template-columns:1fr 1fr;} }
  </style>
</head>
<body>
  <div class="contenedor">
    <div class="top-bar">SCHOOLCOIN</div>
    <div class="header">IES-SchoolCoin</div>

    <div class="row" style="align-items:center;">
      <div style="flex:0 0 120px; text-align:center;">
        <div style="width:72px;height:72px;margin:8px auto;"><img src="LOGO.png" alt="Logo" style="width:100%;height:100%;object-fit:contain;"></div>
        <div id="valorDisplay" style="font-weight:800;font-size:22px;margin-top:6px;text-align:center;">0.00 €</div>
      </div>

      <div class="col">
        <div style="font-weight:700;margin-bottom:6px;">Gráfica</div>
        <div class="chart-wrap"><canvas id="grafica"></canvas></div>
      </div>

      <div class="col">
        <div style="font-weight:700;margin-bottom:6px;">Controles</div>
        <div class="vol-control">
          <div style="font-weight:700;margin-bottom:6px;">Control de volatilidad</div>
          <div class="vol-row">
            <label>Ruido</label>
            <input id="noiseRange" type="range" min="0" max="10" value="4">
            <div id="noiseVal" style="width:48px;text-align:right;">4</div>
          </div>
          <div class="vol-row">
            <label>Saltos %</label>
            <input id="jumpRange" type="range" min="0" max="20" value="6">
            <div id="jumpVal" style="width:48px;text-align:right;">6</div>
          </div>
          <div class="vol-row">
            <label>Prob. salto</label>
            <input id="jumpProb" type="range" min="0" max="100" value="8">
            <div id="jumpProbVal" style="width:48px;text-align:right;">8%</div>
          </div>
        </div>
      </div>
    </div>

    <div class="botones" style="margin-top:14px;">
      <div class="boton" id="btnEnviar">Enviar</div>
      <div class="boton" id="btnIngresos">Ingresos</div>
      <div class="boton" id="btnCambiar">Cambiar</div>
      <div class="boton" id="btnCuenta">Mi cuenta</div>
    </div>

    <div class="controls">
      <button class="control-btn" id="pauseBtn">Pausar actualizaciones</button>
      <button class="control-btn" id="addSample">Añadir valor ahora</button>
    </div>

    <div class="info-box" id="infoBox">Toca o haz clic en un punto para ver su fecha, hora y valor. Mi cuenta está vacía hasta que envíes o recibas SC.</div>
  </div>

  <!-- Chart.js + adapter -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

  <script>
    // ---------- Config y util ----------
    const UPDATE_INTERVAL_MS = 5000;
    const PRESET_POINTS = 600;
    const BASE = 0.175;
    const MIN = 0.10;
    const MAX = 0.30;

    const noiseRange = document.getElementById('noiseRange');
    const noiseVal = document.getElementById('noiseVal');
    const jumpRange = document.getElementById('jumpRange');
    const jumpVal = document.getElementById('jumpVal');
    const jumpProb = document.getElementById('jumpProb');
    const jumpProbVal = document.getElementById('jumpProbVal');

    function getNoiseAmp(){ return Number(noiseRange.value) / 10; }
    function getJumpPct(){ return Number(jumpRange.value) / 100; }
    function getJumpProb(){ return Number(jumpProb.value) / 100; }

    noiseRange.addEventListener('input', () => { noiseVal.textContent = noiseRange.value; });
    jumpRange.addEventListener('input', () => { jumpVal.textContent = jumpRange.value; });
    jumpProb.addEventListener('input', () => { jumpProbVal.textContent = jumpProb.value + '%'; });

    function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
    function formatMoney(v){ return Number(v).toFixed(2) + ' €'; }
    function formatDate(d){ return new Date(d).toLocaleString('es-ES', {year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit'}); }
    function randomHex(len=8){ const chars='0123456789abcdef'; let s=''; for(let i=0;i<len;i++) s+=chars[Math.floor(Math.random()*chars.length)]; return s; }

    // ---------- Generación inicial ----------
    function nextValueBase(prev, noiseAmp, meanStrength, jumpChanceFactor){
      const meanReversion = (BASE - prev) * meanStrength;
      const noise = (Math.random() - 0.5) * 2 * 0.004 * noiseAmp;
      let v = prev + meanReversion + noise;
      const prob = getJumpProb() * jumpChanceFactor;
      if(Math.random() < prob){
        const jumpPct = (Math.random() * 2 - 1) * getJumpPct();
        v = v * (1 + jumpPct);
      }
      return clamp(v, MIN, MAX);
    }

    function nextValue(prev){
      const noiseAmp = 0.2 + getNoiseAmp() * 1.6;
      const meanStrength = 0.06 - getNoiseAmp() * 0.03;
      const jumpChanceFactor = 0.5 + getNoiseAmp() * 1.0;
      return Number(nextValueBase(prev, noiseAmp, meanStrength, jumpChanceFactor).toFixed(4));
    }

    function generateInitialSeries(){
      const labels = [];
      const data = [];
      const nowAligned = Math.floor(Date.now() / UPDATE_INTERVAL_MS) * UPDATE_INTERVAL_MS;
      const start = nowAligned - (PRESET_POINTS - 1) * UPDATE_INTERVAL_MS;
      let val = BASE + (Math.random() - 0.5) * 0.02;
      for(let i=0;i<PRESET_POINTS;i++){
        labels.push(new Date(start + i * UPDATE_INTERVAL_MS));
        val = nextValueBase(val, 0.4, 0.06, 0.06);
        data.push(Number(val.toFixed(4)));
      }
      return {labels, data};
    }

    const initial = generateInitialSeries();
    const masterLabels = initial.labels.slice();
    const masterValues = initial.data.slice();

    // TRANSACTIONS vacías por defecto
    const TRANSACTIONS = [];

    // ---------- Chart ----------
    const ctx = document.getElementById('grafica').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: masterLabels.slice(),
        datasets: [{
          label: 'SCHOOLCOIN',
          data: masterValues.slice(),
          borderColor: '#0b8a3e',
          borderWidth: 1,
          backgroundColor: 'rgba(11,138,62,0.12)',
          pointRadius: (ctx) => ctx.active ? 6 : 0,
          pointHoverRadius: 6,
          pointHitRadius: 12,
          tension: 0.18,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 0 },
        interaction: { mode: 'nearest', intersect: false },
        plugins: {
          legend: { display: false },
          tooltip: {
            enabled: true,
            callbacks: {
              label: function(c){
                const v = Number(c.parsed.y).toFixed(4);
                const date = c.label instanceof Date ? formatDate(c.label) : c.label;
                return ` ${v} € — ${date}`;
              }
            }
          }
        },
        scales: {
          x: {
            type: 'time',
            time: { unit: 'second', displayFormats: { second: 'HH:mm:ss' } },
            grid: { display: false },
            ticks: { display: false }
          },
          y: {
            beginAtZero: false,
            suggestedMin: MIN - 0.01,
            suggestedMax: MAX + 0.01,
            grid: { display: false },
            ticks: { callback: v => Number(v).toFixed(2) + ' €', color: '#333' }
          }
        }
      }
    });

    // Exponer chart para modal detalle
    window.chartInstance = chart;

    // UI refs
    const valorDisplay = document.getElementById('valorDisplay');
    const infoBox = document.getElementById('infoBox');
    const trendText = document.getElementById('trendText'); // may be undefined in this layout

    function updateMainDisplay(value, date){
      valorDisplay.textContent = formatMoney(value);
      // color by direction
      const prev = chart.data.datasets[0].data.length > 1 ? chart.data.datasets[0].data[chart.data.datasets[0].data.length - 2] : value;
      const diff = value - prev;
      valorDisplay.style.color = diff > 0 ? 'var(--accent)' : (diff < 0 ? 'var(--danger)' : 'var(--text)');
      // timestamp shown in infoBox for compact layout
      infoBox.textContent = `${formatDate(date)} · ${diff>0?'▲':'▼'} ${prev?((diff/prev)*100).toFixed(2)+'%':''}`;
    }

    // selection helpers
    function clearActiveSelection(){
      try{ chart.setActiveElements([]); chart.tooltip.setActiveElements([], {x:0,y:0}); chart.update('none'); }catch(e){}
    }
    function highlightPoint(index){
      if(index == null) return;
      clearActiveSelection();
      const active = [{datasetIndex:0, index}];
      chart.setActiveElements(active);
      const x = chart.scales.x.getPixelForValue(chart.data.labels[index]);
      const y = chart.scales.y.getPixelForValue(chart.data.datasets[0].data[index]);
      chart.tooltip.setActiveElements(active, {x,y});
      chart.update('none');
      const val = chart.data.datasets[0].data[index];
      const lab = chart.data.labels[index];
      infoBox.textContent = `Punto: ${Number(val).toFixed(4)} € — ${formatDate(new Date(lab))}`;
    }
    window.highlightPoint = highlightPoint;

    // canvas interactions
    const canvasEl = document.getElementById('grafica');
    canvasEl.addEventListener('mousemove', (evt) => {
      const pts = chart.getElementsAtEventForMode(evt, 'nearest', {intersect: true}, true);
      if(pts.length) highlightPoint(pts[0].index);
      else {
        const pts2 = chart.getElementsAtEventForMode(evt, 'nearest', {intersect: false}, true);
        if(pts2.length) highlightPoint(pts2[0].index);
      }
    });
    canvasEl.addEventListener('mouseleave', () => { clearActiveSelection(); infoBox.textContent = 'Toca o haz clic en un punto para ver su fecha, hora y valor.'; });
    canvasEl.addEventListener('click', (evt) => {
      const pts = chart.getElementsAtEventForMode(evt, 'nearest', {intersect: true}, true);
      if(pts.length) highlightPoint(pts[0].index);
      else {
        const pts2 = chart.getElementsAtEventForMode(evt, 'nearest', {intersect: false}, true);
        if(pts2.length) highlightPoint(pts2[0].index);
      }
    });
    canvasEl.addEventListener('touchend', (e) => {
      if(e.changedTouches && e.changedTouches.length){
        const t = e.changedTouches[0];
        const simulated = {clientX: t.clientX, clientY: t.clientY};
        const pts = chart.getElementsAtEventForMode(simulated, 'nearest', {intersect: true}, true);
        if(pts.length) highlightPoint(pts[0].index);
        else {
          const pts2 = chart.getElementsAtEventForMode(simulated, 'nearest', {intersect: false}, true);
          if(pts2.length) highlightPoint(pts2[0].index);
        }
      }
    }, {passive:true});

    // initial display
    updateMainDisplay(chart.data.datasets[0].data[chart.data.datasets[0].data.length - 1], new Date(chart.data.labels[chart.data.labels.length - 1]));

    // ---------- Updates ----------
    let paused = false;
    let updateTimer = null;

    function pushNewMasterPoint(nextDate, newMasterVal){
      clearActiveSelection();
      masterLabels.push(nextDate);
      masterValues.push(newMasterVal);
      if(masterLabels.length > PRESET_POINTS){ masterLabels.shift(); masterValues.shift(); }

      const lastSmoothed = chart.data.datasets[0].data[chart.data.datasets[0].data.length - 1];
      const raw = newMasterVal + (Math.random() - 0.5) * getNoiseAmp() * 0.002;
      const alpha = 0.12;
      const smoothed = lastSmoothed * (1 - alpha) + raw * alpha;

      chart.data.labels.push(nextDate);
      chart.data.datasets[0].data.push(Number(clamp(smoothed, MIN, MAX).toFixed(4)));
      if(chart.data.labels.length > PRESET_POINTS){ chart.data.labels.shift(); chart.data.datasets[0].data.shift(); }
      chart.update('none');

      setTimeout(() => clearActiveSelection(), 20);
      updateMainDisplay(chart.data.datasets[0].data[chart.data.datasets[0].data.length - 1], nextDate);
    }

    function scheduleNextUpdate(){
      if(updateTimer) clearInterval(updateTimer);
      updateTimer = setInterval(() => {
        if(paused) return;
        const lastLabel = masterLabels[masterLabels.length - 1];
        const lastTime = (lastLabel instanceof Date) ? lastLabel.getTime() : new Date(lastLabel).getTime();
        const nextTime = new Date(lastTime + UPDATE_INTERVAL_MS);
        const prev = masterValues[masterValues.length - 1];
        const nv = nextValue(prev);
        pushNewMasterPoint(nextTime, nv);
      }, UPDATE_INTERVAL_MS);
    }
    scheduleNextUpdate();

    // ---------- Modal helpers ----------
    function openModal(htmlContent){
      const bd = document.createElement('div');
      bd.className = 'modal-backdrop';
      bd.innerHTML = `<div class="modal">${htmlContent}</div>`;
      document.body.appendChild(bd);
      bd.addEventListener('click', (e) => { if(e.target === bd) bd.remove(); });
      return bd;
    }
    function closeModal(bd){ if(bd && bd.remove) bd.remove(); }

    // ---------- Buttons: Enviar / Ingresos / Cambiar / Mi cuenta ----------
    document.getElementById('btnEnviar').addEventListener('click', () => {
      const html = `<h3>Enviar SCHOOLCOIN</h3>
        <label>Destinatario</label><input id="m_dest" placeholder="Dirección o usuario" style="width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #ddd;">
        <label style="margin-top:8px;">Cantidad (SC)</label><input id="m_amt" type="number" step="0.0001" placeholder="0.01" style="width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #ddd;">
        <div style="display:flex;gap:8px;margin-top:12px;"><button class="btn-small" id="m_cancel">Cancelar</button><button class="btn-small" id="m_send">Enviar</button></div>`;
      const bd = openModal(html);
      bd.querySelector('#m_cancel').addEventListener('click', () => closeModal(bd));
      bd.querySelector('#m_send').addEventListener('click', () => {
        const dest = bd.querySelector('#m_dest').value || 'desconocido';
        const amt = parseFloat(bd.querySelector('#m_amt').value) || 0;
        const lastIndex = masterLabels.length - 1;
        TRANSACTIONS.push({txid: randomHex(16), type:'envio', from:'you', to:dest, amount: Number(amt.toFixed(4)), timestamp: new Date(masterLabels[lastIndex]).toISOString(), index: lastIndex});
        const prev = masterValues[masterValues.length - 1];
        const impact = clamp(amt * 0.00002, 0, 0.003);
        const nv = clamp(prev + impact * (Math.random() > 0.5 ? 1 : -1), MIN, MAX);
        const nextTime = new Date(((masterLabels[lastIndex] instanceof Date) ? masterLabels[lastIndex].getTime() : new Date(masterLabels[lastIndex]).getTime()) + UPDATE_INTERVAL_MS);
        pushNewMasterPoint(nextTime, Number(nv.toFixed(4)));
        bd.querySelector('.modal').innerHTML = `<h3>Enviado</h3><p>Enviado ${amt.toFixed(4)} SC a ${dest}.</p><div style="display:flex;justify-content:flex-end;margin-top:12px;"><button class="btn-small" id="m_ok">Aceptar</button></div>`;
        bd.querySelector('#m_ok').addEventListener('click', () => closeModal(bd));
      });
    });

    document.getElementById('btnIngresos').addEventListener('click', () => {
      const html = `<h3>Registrar ingreso</h3>
        <label>Origen</label><input id="i_from" placeholder="Usuario o fuente" style="width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #ddd;">
        <label style="margin-top:8px;">Cantidad (SC)</label><input id="i_amt" type="number" step="0.01" placeholder="10.00" style="width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #ddd;">
        <div style="display:flex;gap:8px;margin-top:12px;"><button class="btn-small" id="i_cancel">Cancelar</button><button class="btn-small" id="i_ok">Confirmar</button></div>`;
      const bd = openModal(html);
      bd.querySelector('#i_cancel').addEventListener('click', () => closeModal(bd));
      bd.querySelector('#i_ok').addEventListener('click', () => {
        const from = bd.querySelector('#i_from').value || 'external';
        const amt = parseFloat(bd.querySelector('#i_amt').value) || 0;
        const lastIndex = masterLabels.length - 1;
        TRANSACTIONS.push({txid: randomHex(16), type:'ingreso', from, to:'you', amount: Number(amt.toFixed(4)), timestamp: new Date(masterLabels[lastIndex]).toISOString(), index: lastIndex});
        const prev = masterValues[masterValues.length - 1];
        const nv = clamp(prev + clamp(amt * 0.00002, 0, 0.003), MIN, MAX);
        const nextTime = new Date(((masterLabels[lastIndex] instanceof Date) ? masterLabels[lastIndex].getTime() : new Date(masterLabels[lastIndex]).getTime()) + UPDATE_INTERVAL_MS);
        pushNewMasterPoint(nextTime, Number(nv.toFixed(4)));
        bd.querySelector('.modal').innerHTML = `<h3>Ingreso registrado</h3><p>+${amt.toFixed(2)} SC — transacción añadida.</p><div style="display:flex;justify-content:flex-end;margin-top:12px;"><button class="btn-small" id="i_done">Aceptar</button></div>`;
        bd.querySelector('#i_done').addEventListener('click', () => closeModal(bd));
      });
    });

    document.getElementById('btnCambiar').addEventListener('click', () => {
      const currentPrice = Number(chart.data.datasets[0].data[chart.data.datasets[0].data.length - 1]);
      const html = `<h3>Cambiar SchoolCoins a €</h3>
        <label>Cantidad (SC)</label><input id="c_amt" type="number" step="0.0001" placeholder="10.00" style="width:100%;padding:8px;margin-top:6px;border-radius:8px;border:1px solid #ddd;">
        <div style="margin-top:8px;font-size:13px;color:#555;">Precio actual: <strong>${currentPrice.toFixed(4)} €</strong> por SC</div>
        <div style="margin-top:8px;font-size:13px;color:#555;">Equivalencia: <span id="c_equiv">0.00 €</span></div>
        <div style="display:flex;gap:8px;margin-top:12px;"><button class="btn-small" id="c_cancel">Cancelar</button><button class="btn-small" id="c_ok">Cambiar</button></div>`;
      const bd = openModal(html);
      const input = bd.querySelector('#c_amt');
      const equiv = bd.querySelector('#c_equiv');
      input.addEventListener('input', () => { const v = parseFloat(input.value) || 0; equiv.textContent = (v * currentPrice).toFixed(4) + ' €'; });
      bd.querySelector('#c_cancel').addEventListener('click', () => closeModal(bd));
      bd.querySelector('#c_ok').addEventListener('click', () => {
        const amt = parseFloat(input.value) || 0;
        if(amt <= 0){ equiv.textContent = 'Introduce una cantidad válida'; return; }
        const lastIndex = masterLabels.length - 1;
        TRANSACTIONS.push({txid: randomHex(16), type:'cambio', from:'you', to:'exchange', amount: Number(amt.toFixed(4)), euro: Number((amt * currentPrice).toFixed(4)), timestamp: new Date(masterLabels[lastIndex]).toISOString(), index: lastIndex});
        const prev = masterValues[masterValues.length - 1];
        const nv = clamp(prev + (Math.random()-0.5) * 0.0008, MIN, MAX);
        const nextTime = new Date(((masterLabels[lastIndex] instanceof Date) ? masterLabels[lastIndex].getTime() : new Date(masterLabels[lastIndex]).getTime()) + UPDATE_INTERVAL_MS);
        pushNewMasterPoint(nextTime, Number(nv.toFixed(4)));
        bd.querySelector('.modal').innerHTML = `<h3>Cambio realizado</h3><p>${amt.toFixed(4)} SC → ${(amt*currentPrice).toFixed(4)} €</p><div style="display:flex;justify-content:flex-end;margin-top:12px;"><button class="btn-small" id="c_done">Aceptar</button></div>`;
        bd.querySelector('#c_done').addEventListener('click', () => closeModal(bd));
      });
    });

    // Mi cuenta: bonita, simplificada, detalle al pulsar
    document.getElementById('btnCuenta').addEventListener('click', () => {
      renderAccountModal('all', 0);
    });

    function renderAccountModal(filter='all', page=0){
      const PAGE_SIZE = 10;
      let filtered = TRANSACTIONS.slice();
      if(filter !== 'all') filtered = filtered.filter(t => t.type === filter);
      const total = filtered.length;
      const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      const start = page * PAGE_SIZE;
      const pageItems = filtered.slice().reverse().slice(start, start + PAGE_SIZE);

      const filtersHtml = `
        <div class="filters">
          <button class="filter-btn ${filter==='all'?'filter-active':''}" data-filter="all">Todos</button>
          <button class="filter-btn ${filter==='ingreso'?'filter-active':''}" data-filter="ingreso">Ingresos</button>
          <button class="filter-btn ${filter==='gasto'?'filter-active':''}" data-filter="gasto">Gastos</button>
          <button class="filter-btn ${filter==='envio'?'filter-active':''}" data-filter="envio">Envíos</button>
          <button class="filter-btn ${filter==='cambio'?'filter-active':''}" data-filter="cambio">Cambios</button>
        </div>`;

      let listHtml = '';
      if(pageItems.length === 0){
        listHtml = `<div class="empty">No hay transacciones que coincidan.</div>`;
      } else {
        listHtml = `<div class="tx-list">`;
        pageItems.forEach(tx => {
          const shortId = tx.txid.slice(0,12) + (tx.txid.length>12 ? '…' : '');
          const typeClass = tx.type === 'gasto' ? 'gasto' : '';
          const amountLabel = tx.type === 'cambio' ? `${Number(tx.amount).toFixed(4)} SC → ${Number(tx.euro).toFixed(4)} €` : `${Number(tx.amount).toFixed(4)} SC`;
          listHtml += `
            <div class="tx-card" data-txid="${tx.txid}">
              <div class="tx-left">
                <div class="tx-id">${shortId}</div>
                <div class="tx-meta"><span class="muted">${formatDate(tx.timestamp)}</span> · <span class="tx-type ${typeClass}">${tx.type}</span></div>
              </div>
              <div class="tx-amount">${amountLabel}</div>
            </div>`;
        });
        listHtml += `</div>`;
      }

      const pagerHtml = `
        <div style="display:flex;gap:8px;justify-content:center;margin-top:12px;">
          <button class="btn-small" id="prevPage" ${page===0?'disabled':''}>Anterior</button>
          <div style="align-self:center;color:var(--muted)">Página ${page+1} / ${totalPages}</div>
          <button class="btn-small" id="nextPage" ${page+1>=totalPages?'disabled':''}>Siguiente</button>
        </div>`;

      const modalHtml = `
        <h3>Mi cuenta</h3>
        ${filtersHtml}
        ${listHtml}
        ${pagerHtml}
        <div style="display:flex;justify-content:flex-end;margin-top:12px;"><button class="btn-small" id="closeAccount">Cerrar</button></div>
      `;

      const bd = openModal(modalHtml);

      bd.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const f = btn.getAttribute('data-filter');
          bd.remove();
          renderAccountModal(f, 0);
        });
      });

      const prev = bd.querySelector('#prevPage');
      const next = bd.querySelector('#nextPage');
      if(prev) prev.addEventListener('click', () => { bd.remove(); renderAccountModal(filter, Math.max(0, page-1)); });
      if(next) next.addEventListener('click', () => { bd.remove(); renderAccountModal(filter, page+1); });

      const closeBtn = bd.querySelector('#closeAccount');
      if(closeBtn) closeBtn.addEventListener('click', () => closeModal(bd));

      bd.querySelectorAll('.tx-card').forEach(card => {
        card.addEventListener('click', () => {
          const txid = card.getAttribute('data-txid');
          const tx = TRANSACTIONS.find(t => t.txid === txid);
          if(!tx) return;
          const detailHtml = `
            <h3>Transacción</h3>
            <div class="tx-detail">
              <div style="font-weight:900;margin-bottom:8px;">${tx.txid}</div>
              <div class="muted">Tipo</div><div style="margin-bottom:8px;font-weight:700;">${tx.type}</div>
              <div class="muted">De</div><div style="margin-bottom:8px;">${tx.from}</div>
              <div class="muted">A</div><div style="margin-bottom:8px;">${tx.to}</div>
              <div class="muted">Cantidad</div><div style="margin-bottom:8px;font-weight:900;">${Number(tx.amount).toFixed(4)} SC ${tx.type==='cambio'?`→ ${Number(tx.euro).toFixed(4)} €`:''}</div>
              <div class="muted">Fecha</div><div style="margin-bottom:12px;">${new Date(tx.timestamp).toLocaleString('es-ES')}</div>
              <div style="display:flex;gap:8px;justify-content:flex-end;">
                <button class="btn-small" id="backList">Volver</button>
                <button class="btn-small" id="focusGraph">Ver en gráfica</button>
              </div>
            </div>
          `;
          bd.querySelector('.modal').innerHTML = detailHtml;
          bd.querySelector('#backList').addEventListener('click', () => { bd.remove(); renderAccountModal(filter, page); });
          bd.querySelector('#focusGraph').addEventListener('click', () => {
            if(typeof tx.index !== 'undefined') highlightPoint(tx.index);
          });
        });
      });
    }

    // ---------- Pause / Add sample ----------
    document.getElementById('pauseBtn').addEventListener('click', () => {
      paused = !paused;
      document.getElementById('pauseBtn').textContent = paused ? 'Reanudar actualizaciones' : 'Pausar actualizaciones';
    });
    document.getElementById('addSample').addEventListener('click', () => {
      const lastLabel = masterLabels[masterLabels.length - 1];
      const lastTime = (lastLabel instanceof Date) ? lastLabel.getTime() : new Date(lastLabel).getTime();
      const nextTime = new Date(lastTime + UPDATE_INTERVAL_MS);
      const prev = masterValues[masterValues.length - 1];
      const nv = nextValue(prev);
      pushNewMasterPoint(nextTime, nv);
    });

    // Forzar render inicial
    window.addEventListener('load', () => setTimeout(()=>chart.resize(),100));
  </script>
</body>
</html>