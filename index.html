<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SCHOOLCOIN - App</title>
  <style>
    :root{
      --app-bg: #f7d54a;
      --chart-color: #0b8a3e;
      --text: #111;
      --muted: #666;
      --card-bg: #fff;
      --danger: #c62828;
      --shadow: 0 8px 28px rgba(0,0,0,0.12);
      --font-family: Inter, Arial, sans-serif;
    }

    html,body{
      min-height:100vh;
      margin:0;
      padding:0;
      box-sizing:border-box;
      background-repeat:no-repeat;
      background-size:cover;
      background-position:center;
      background-attachment:fixed;
      transition:background 300ms ease, color 200ms ease;
      color:var(--text);
      font-family:var(--font-family);
      -webkit-font-smoothing:antialiased;
    }
    html {
      height:100%;
      min-height:100vh;
    }
    html {
      height:100%;
    }
    body {
      min-height:100vh;
    }

    .contenedor{width:100%;max-width:980px;margin:0 auto;padding:18px;box-sizing:border-box;min-height:100vh;position:relative;z-index:1;}
    .top-bar{background:#000;color:#fff;padding:12px;font-weight:800;text-align:center;border-radius:10px;position:relative;}
    .top-left-actions{position:absolute;left:12px;top:8px;display:flex;gap:8px;align-items:center;}
    .top-right-actions{position:absolute;right:12px;top:8px;display:flex;gap:8px;align-items:center;}
    .header{margin-top:10px;font-size:22px;font-weight:800;text-align:center;color:var(--text);}
    .row{display:flex;gap:12px;align-items:flex-start;flex-wrap:wrap;margin-top:8px;}
    .col{flex:1;min-width:300px;}
    .chart-wrap{margin-top:8px;border-radius:12px;padding:4px;background:transparent;}
    canvas{width:100% !important;height:260px !important;display:block;border-radius:8px;background:transparent;}
    @media (max-width:900px){ canvas{height:200px !important;} }

    .botones{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:10px;}
    .boton{background:var(--chart-color);color:#fff;padding:12px;border-radius:10px;font-weight:700;text-align:center;cursor:pointer;user-select:none;box-shadow:var(--shadow);border:0;}
    .control-btn{background:#fff;border:1px solid rgba(0,0,0,0.08);padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:700;}
    .icon-btn{background:transparent;border:0;color:#fff;cursor:pointer;padding:6px;border-radius:8px;font-weight:700;}
    .icon-btn svg{width:20px;height:20px;vertical-align:middle;fill:#fff;opacity:0.95;}

    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;}
    .modal{width:100%;max-width:920px;border-radius:14px;background:linear-gradient(180deg,var(--card-bg),#fbfbfb);box-shadow:var(--shadow);overflow:hidden;border:1px solid rgba(0,0,0,0.06);}
    .modal-header{padding:14px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid rgba(0,0,0,0.04);}
    .modal-header h3{margin:0;font-size:16px;color:var(--text);}
    .modal-body{padding:14px 16px;max-height:72vh;overflow:auto;box-sizing:border-box;}
    .modal-body::-webkit-scrollbar{width:8px;}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:12px;}
    .field label{font-weight:700;font-size:13px;color:var(--text);}
    .field input[type="text"], .field input[type="number"], .field input[type="password"], .field select, .field input[type="color"], .field input[type="email"], .field textarea, .field input[type="date"]{
      padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.08);font-size:14px;background:#fff;box-sizing:border-box;
    }
    .row-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:8px;}
    .btn-primary{background:var(--chart-color);color:#fff;border:0;padding:10px 12px;border-radius:10px;font-weight:800;cursor:pointer;}
    .btn-ghost{background:transparent;border:1px solid rgba(0,0,0,0.06);padding:10px 12px;border-radius:10px;cursor:pointer;}
    .muted{color:var(--muted);font-size:13px;}
    .small-note{font-size:12px;color:var(--muted);margin-top:6px;}
    .bg-btn{padding:8px 10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:#fff;cursor:pointer;}
    .bg-btn[aria-pressed="true"]{outline:3px solid rgba(0,0,0,0.06);transform:scale(1.02);}

    .login-backdrop{position:fixed;inset:0;background:linear-gradient(rgba(0,0,0,0.55),rgba(0,0,0,0.55));display:flex;align-items:center;justify-content:center;z-index:10000;padding:20px;}
    .login-card{width:100%;max-width:520px;background:var(--card-bg);padding:18px;border-radius:14px;box-shadow:var(--shadow);border:1px solid rgba(0,0,0,0.06);}
    .login-card h2{margin:0 0 8px 0;font-size:20px;color:var(--text);}
    .login-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px;}

    .steps { display:flex;gap:12px;margin-bottom:12px;align-items:center;flex-wrap:wrap; }
    .step-dot { width:28px;height:28px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;background:#eee;color:#333;font-weight:700;border:2px solid rgba(0,0,0,0.04); }
    .step-dot.active { background:var(--chart-color); color:#fff; border-color:var(--chart-color); }
    .step-label { font-size:13px;color:var(--muted); }

    .full-loader{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6);z-index:11000;flex-direction:column;color:#fff;}
    .spinner{
      width:120px;height:120px;border-radius:50%;border:12px solid rgba(255,255,255,0.12);border-top-color:rgba(255,255,255,0.95);
      animation:spin 1s linear infinite;margin-bottom:18px;
    }
    @keyframes spin{to{transform:rotate(360deg);}}

    .info-content h4{margin:8px 0 6px 0;color:var(--text);}
    .info-content p{margin:6px 0;color:var(--muted);line-height:1.45;}
    .info-section{margin-bottom:12px;padding-bottom:8px;border-bottom:1px dashed rgba(0,0,0,0.04);}

    @media (max-width:900px){ .contenedor{max-width:420px;} .botones{grid-template-columns:1fr 1fr;} .login-card{max-width:92vw;} .modal{max-width:92vw;} }
  </style>
<base target="_blank">
</head>
<body>
  <div class="contenedor" id="appRoot" aria-hidden="true">
    <div class="top-bar">
      SCHOOLCOIN
      <div class="top-left-actions">
        <button id="infoBtn" class="icon-btn" title="Información" aria-label="Información">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
  <path d="M8 8a4 4 0 1 1 8 0c0 2-3 3-3 6"/>
  <line x1="12" y1="18" x2="12.01" y2="18"/>
</svg>
        </button>
      </div>
      <div class="top-right-actions">
        <button id="settingsBtn" class="icon-btn" title="Apariencia" aria-label="Apariencia">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
  <circle cx="12" cy="12" r="3"/>
  <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
</svg>
        </button>
      </div>
    </div>

    <div class="header">IES-SchoolCoin</div>

    <div class="row" style="align-items:center;">
      <div style="flex:1; text-align:center; display:flex; flex-direction:column; align-items:center; justify-content:center;">
        <div style="width:84px;height:84px;margin:8px auto;"><img src="LOGO.png" alt="Logo" style="width:100%;height:100%;object-fit:contain;"></div>
        <div id="valorDisplay" style="font-weight:900;font-size:28px;margin-top:6px;text-align:center;">0.000 €</div>
      </div>

      <div class="col">
        
        <div class="chart-wrap"><canvas id="grafica"></canvas></div>
      </div>
    </div>

    <div class="botones" style="margin-top:14px;">
      <div class="boton" id="btnEnviar">Enviar</div>
      <div class="boton" id="btnIngresos">Ingresos</div>
      <div class="boton" id="btnCambiar">Cambiar</div>
      <div class="boton" id="btnCuenta">Mi cuenta</div>
    </div>

    
  </div>

  <!-- Login overlay with multi-step Create account option -->
  <div id="loginOverlay" class="login-backdrop" role="dialog" aria-modal="true">
    <div class="login-card" role="document">
      <h2>Iniciar sesión</h2>
      <div class="login-note" style="color:var(--muted);">Introduce tu nombre, apellidos y contraseña para acceder a la app.</div>

      <div id="loginForm">
        <div class="field"><label>Nombre</label><input id="loginName" type="text" placeholder="Nombre"></div>
        <div class="field"><label>Apellidos</label><input id="loginSurname" type="text" placeholder="Apellidos"></div>
        <div class="field"><label>Contraseña</label><input id="loginPass" type="password" placeholder="Contraseña"></div>
        <div id="loginError" class="error" style="display:none;color:var(--danger);">Rellena todos los campos para continuar.</div>
        <div class="login-actions">
          <button id="showCreateBtn" class="btn-ghost">Crear cuenta</button>
          <button id="loginBtn" class="btn-primary">Entrar</button>
        </div>
      </div>

      <!-- Multi-step Create account form (hidden by default) -->
      <div id="createForm" style="display:none;margin-top:12px;">
        <h3 style="margin:0 0 8px 0;color:var(--text);">Crear cuenta</h3>

        <!-- Steps indicator with names -->
        <div class="steps" id="stepsIndicator" aria-hidden="false">
          <div style="display:flex;align-items:center;gap:8px;">
            <div class="step-dot active" data-step="1">1</div>
            <div class="step-label">-- Nombre</div>
          </div>
          <div style="display:flex;align-items:center;gap:8px;">
            <div class="step-dot" data-step="2">2</div>
            <div class="step-label">-- Detalles</div>
          </div>
          <div style="display:flex;align-items:center;gap:8px;">
            <div class="step-dot" data-step="3">3</div>
            <div class="step-label">-- Contacto</div>
          </div>
        </div>

        <!-- Step 1 -->
        <div class="step" data-step="1">
          <div class="field"><label>Nombre</label><input id="c_name" type="text" placeholder="Nombre"></div>
          <div class="field"><label>Apellidos</label><input id="c_surname" type="text" placeholder="Apellidos"></div>
          <div class="field"><label>Correo electrónico</label><input id="c_email" type="email" placeholder="tu@ejemplo.com"></div>
          <div class="field"><label>Contraseña</label><input id="c_pass" type="password" placeholder="Contraseña"></div>
          <div class="field"><label>Confirmar contraseña</label><input id="c_pass2" type="password" placeholder="Repite la contraseña"></div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px;">
            <button type="button" id="cancelCreate" class="btn-ghost">Cancelar</button>
            <button type="button" id="nextTo2" class="btn-primary">Siguiente</button>
          </div>
        </div>

        <!-- Step 2 -->
        <div class="step" data-step="2" style="display:none;">
          <div class="field"><label>Fecha de nacimiento</label><input id="c_dob" type="date"></div>
          <div class="field"><label>Curso / Clase</label><input id="c_class" type="text" placeholder="Ej: 4º ESO A"></div>
          <div class="field"><label>DNI</label><input id="c_studentid" type="text" placeholder="Número de DNI"></div>
          <div class="field"><label>Teléfono</label><input id="c_phone" type="text" placeholder="Teléfono"></div>
          <div style="display:flex;gap:8px;justify-content:space-between;margin-top:8px;">
            <button type="button" id="backTo1" class="btn-ghost">Atrás</button>
            <button type="button" id="nextTo3" class="btn-primary">Siguiente</button>
          </div>
        </div>

        <!-- Step 3 -->
        <div class="step" data-step="3" style="display:none;">
          <div class="field"><label>Contacto de padre/madre/tutor</label><input id="c_parent" type="text" placeholder="Nombre y teléfono"></div>
          <div class="field"><label>Dirección</label><input id="c_address" type="text" placeholder="Dirección"></div>
          
          <div style="display:flex;gap:8px;justify-content:space-between;margin-top:8px;">
            <button type="button" id="backTo2" class="btn-ghost">Atrás</button>
            <button type="button" id="submitCreate" class="btn-primary">Crear cuenta</button>
          </div>
          <div id="createError" class="error" style="display:none;color:var(--danger);margin-top:8px;"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Full-screen loader (hidden by default) -->
  <div id="fullLoader" class="full-loader" style="display:none;">
    <div class="spinner" role="status" aria-hidden="true"></div>
    <div style="font-size:20px;font-weight:800;margin-bottom:8px;">Creando tu cuenta...</div>
    <div style="font-size:14px;opacity:0.9;">Creando tu cuenta...</div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

  <script>
    /* ---------------- Auth + multi-step create account flow ---------------- */
    const loginOverlay = document.getElementById('loginOverlay');
    const appRoot = document.getElementById('appRoot');
    const loginBtn = document.getElementById('loginBtn');
    const loginError = document.getElementById('loginError');
    const showCreateBtn = document.getElementById('showCreateBtn');
    const createForm = document.getElementById('createForm');
    const loginForm = document.getElementById('loginForm');
    const cancelCreate = document.getElementById('cancelCreate');
    const submitCreate = document.getElementById('submitCreate');
    const fullLoader = document.getElementById('fullLoader');
    const createError = document.getElementById('createError');

    const steps = Array.from(document.querySelectorAll('.step'));
    const stepDots = Array.from(document.querySelectorAll('.step-dot'));
    let currentStep = 1;

    function showStep(n){
      currentStep = n;
      steps.forEach(s => s.style.display = s.dataset.step == n ? 'block' : 'none');
      stepDots.forEach(d => {
        if (Number(d.dataset.step) === n) d.classList.add('active'); else d.classList.remove('active');
      });
      const modalBody = document.querySelector('.modal-body');
      if(modalBody) modalBody.scrollTop = 0;
    }

    function isLoggedIn(){ try { return sessionStorage.getItem('schoolcoin_user') !== null; } catch(e){ return false; } }
    function showAppAfterLogin(){ loginOverlay.style.display = 'none'; appRoot.setAttribute('aria-hidden','false'); }
    function saveSession(user){ try { sessionStorage.setItem('schoolcoin_user', JSON.stringify(user)); } catch(e){} }

    // Siempre mostrar login al cargar la página (incluso si hay sesión previa)
    loginOverlay.style.display = 'flex'; 
    appRoot.setAttribute('aria-hidden','true');
    // Limpiar cualquier sesión previa para forzar login
    try { sessionStorage.removeItem('schoolcoin_user'); } catch(e){}

    loginBtn.addEventListener('click', () => {
      const name = document.getElementById('loginName').value || '';
      const surname = document.getElementById('loginSurname').value || '';
      const pass = document.getElementById('loginPass').value || '';
      if(!name.trim() || !surname.trim() || !pass.trim()){ loginError.style.display = 'block'; return; }
      loginError.style.display = 'none';
      saveSession({ name: name.trim(), surname: surname.trim(), loggedAt: new Date().toISOString() });
      showAppAfterLogin();
    });

    showCreateBtn.addEventListener('click', () => {
      loginForm.style.display = 'none';
      createForm.style.display = 'block';
      createError.style.display = 'none';
      showStep(1);
    });

    cancelCreate.addEventListener('click', () => {
      createForm.style.display = 'none';
      loginForm.style.display = 'block';
    });

    document.getElementById('nextTo2').addEventListener('click', () => {
      const name = document.getElementById('c_name').value.trim();
      const surname = document.getElementById('c_surname').value.trim();
      const email = document.getElementById('c_email').value.trim();
      const pass = document.getElementById('c_pass').value;
      const pass2 = document.getElementById('c_pass2').value;
      if(!name || !surname || !email || !pass || !pass2 || pass !== pass2){
        createError.style.display = 'block';
        createError.textContent = 'Rellena los campos obligatorios y asegúrate de que las contraseñas coinciden.';
        return;
      }
      createError.style.display = 'none';
      showStep(2);
    });

    document.getElementById('backTo1').addEventListener('click', () => { showStep(1); });
    document.getElementById('nextTo3').addEventListener('click', () => { showStep(3); });
    document.getElementById('backTo2').addEventListener('click', () => { showStep(2); });

    const submitCreateBtn = document.getElementById('submitCreate');
    if(submitCreateBtn) {
      submitCreateBtn.addEventListener('click', () => {
      createError.style.display = 'none';
      const data = {
        name: document.getElementById('c_name').value || '',
        surname: document.getElementById('c_surname').value || '',
        email: document.getElementById('c_email').value || '',
        pass: document.getElementById('c_pass').value || '',
        pass2: document.getElementById('c_pass2').value || '',
        dob: document.getElementById('c_dob').value || '',
        class: document.getElementById('c_class').value || '',
        studentid: document.getElementById('c_studentid').value || '',
        phone: document.getElementById('c_phone').value || '',
        parent: document.getElementById('c_parent').value || '',
        address: document.getElementById('c_address').value || ''
      };

      if(!data.name || !data.surname || !data.email || !data.pass || !data.pass2 || data.pass !== data.pass2){
        createError.style.display = 'block';
        createError.textContent = 'Rellena todos los campos obligatorios y confirma la contraseña.';
        return;
      }

      // Show loader for 2s
      console.log('Creando cuenta...');
      fullLoader.style.display = 'flex';
      setTimeout(() => {
        console.log('Cuenta creada, mostrando mensaje...');
        fullLoader.style.display = 'none';
        saveSession({ name: data.name.trim(), surname: data.surname.trim(), email: data.email.trim(), createdAt: new Date().toISOString() });

        // Close the create form and the entire login overlay; do NOT reopen the login form
        createForm.style.display = 'none';
        loginForm.style.display = 'none';
        loginOverlay.style.display = 'none';
        appRoot.setAttribute('aria-hidden','false');

        const welcomeHtml = `
          <div class="modal-header"><h3>¡Cuenta creada!</h3></div>
          <div class="modal-body" style="text-align:center;">
            <div style="font-weight:900;font-size:20px;margin-bottom:8px;">¡Disfruta la app!</div>
            <div class="muted" style="margin-bottom:12px;">Tu cuenta ha sido creada correctamente. Ya puedes empezar a usar SchoolCoin.</div>
            <div class="row-actions"><button class="btn-primary" id="welcomeOk">Comenzar</button></div>
          </div>`;
        const bd = openModal(welcomeHtml);
        bd.querySelector('#welcomeOk').addEventListener('click', () => closeModal(bd));
      }, 10000);
    });
    }

    /* ---------------- Account code (IES + 8 dígitos) ---------------- */
    function generateSpanishStyleAccountCode() { const prefix = 'IES'; let digits = ''; for (let i = 0; i < 8; i++) digits += Math.floor(Math.random() * 10); return prefix + digits; }
    function getOrCreateAccountCode() { const key = 'schoolcoin_account_code'; try { const stored = localStorage.getItem(key); if (stored && /^IES\d{8}$/.test(stored)) return stored; const code = generateSpanishStyleAccountCode(); localStorage.setItem(key, code); return code; } catch (e) { return generateSpanishStyleAccountCode(); } }
    const accountCode = getOrCreateAccountCode();

    /* ---------------- Modal helpers ---------------- */
    function openModal(contentHtml){
      const bd = document.createElement('div');
      bd.className = 'modal-backdrop';
      bd.innerHTML = `<div class="modal">${contentHtml}</div>`;
      document.body.appendChild(bd);
      bd.addEventListener('click', (e) => { if(e.target === bd) bd.remove(); });
      return bd;
    }
    function closeModal(bd){ if(bd && bd.remove) bd.remove(); }

    /* ---------------- Market simulation & chart ---------------- */
    const UPDATE_INTERVAL_MS = 5000;
    const PRESET_POINTS = 600;
    const MIN = 0.05, MAX = 0.50, BASE = 0.175, MAX_STEP_PER_TICK = 0.0009;

    function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
    function formatDynamicDecimals(num){ if (!isFinite(num)) return String(num); const s = num.toFixed(8).replace(/0+$/,'').replace(/\.$/,''); const parts = s.split('.'); if(parts.length === 1) return parts[0]; const frac = parts[1]; if(frac.length <= 3) return parts[0] + '.' + frac.padEnd(3,'0'); return parts[0] + '.' + frac; }

    function nextValue(prev){
      const meanReversion = (BASE - prev) * 0.10;
      const baseNoise = (Math.random() - 0.5) * 0.0022;
      let candidate = prev + meanReversion + baseNoise;
      if(Math.random() < 0.04){ const jumpPct = (Math.random() * 2 - 1) * 0.02; candidate = candidate * (1 + jumpPct); }
      const delta = candidate - prev;
      const limitedDelta = clamp(delta, -MAX_STEP_PER_TICK, MAX_STEP_PER_TICK);
      const next = clamp(prev + limitedDelta, MIN, MAX);
      return Number(next.toFixed(6));
    }

    function generateInitialSeries(){
      const labels = []; const data = [];
      const nowAligned = Math.floor(Date.now() / UPDATE_INTERVAL_MS) * UPDATE_INTERVAL_MS;
      const start = nowAligned - (PRESET_POINTS - 1) * UPDATE_INTERVAL_MS;
      let val = BASE + (Math.random() - 0.5) * 0.04;
      for(let i=0;i<PRESET_POINTS;i++){ labels.push(new Date(start + i * UPDATE_INTERVAL_MS)); val = nextValue(val); data.push(Number(val.toFixed(6))); }
      return {labels, data};
    }

    const initial = generateInitialSeries();
    const masterLabels = initial.labels.slice();
    const masterValues = initial.data.slice();
    const TRANSACTIONS = [];

    const ctx = document.getElementById('grafica').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: masterLabels.slice(),
        datasets: [{
          label: 'SCHOOLCOIN',
          data: masterValues.slice(),
          borderColor: getComputedStyle(document.documentElement).getPropertyValue('--chart-color').trim() || '#0b8a3e',
          borderWidth: 1,
          backgroundColor: (function(){ const c = getComputedStyle(document.documentElement).getPropertyValue('--chart-color').trim() || '#0b8a3e'; return `rgba(${parseInt(c.slice(1,3),16)},${parseInt(c.slice(3,5),16)},${parseInt(c.slice(5,7),16)},0.10)`; })(),
          pointRadius: (ctx) => ctx.active ? 6 : 0,
          pointHoverRadius: 6,
          pointHitRadius: 12,
          tension: 0.16,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 0 },
        interaction: { mode: 'nearest', intersect: false },
        plugins: {
          legend: { display: false },
          tooltip: {
            enabled: true,
            callbacks: {
              label: function(c){
                const v = Number(c.parsed.y);
                const date = c.label instanceof Date ? new Date(c.label).toLocaleString('es-ES') : c.label;
                return ` ${formatDynamicDecimals(v)} € — ${date}`;
              }
            }
          }
        },
        scales: {
          x: { type: 'time', time: { unit: 'second', displayFormats: { second: 'HH:mm:ss' } }, grid: { display: false }, ticks: { display: false } },
          y: { beginAtZero: false, grid: { display: true, color: 'rgba(0,0,0,0.04)' }, ticks: { color: '#333', callback: v => Number(Number(v).toFixed(2)) + ' €' } }
        }
      }
    });
    window.chartInstance = chart;

    function adjustYAxisToPrice(currentPrice){
      const span = Math.max(0.02, Math.abs(currentPrice) * 0.12);
      const min = clamp(currentPrice - span, MIN, MAX);
      const max = clamp(currentPrice + span, MIN, MAX);
      const margin = (max - min) * 0.06;
      chart.options.scales.y.min = clamp(min - margin, MIN, MAX);
      chart.options.scales.y.max = clamp(max + margin, MIN, MAX);
      chart.update('none');
    }

    const valorDisplay = document.getElementById('valorDisplay');
    function updateMainDisplay(value){
      valorDisplay.textContent = formatDynamicDecimals(value) + ' €';
      const prev = chart.data.datasets[0].data.length > 1 ? chart.data.datasets[0].data[chart.data.datasets[0].data.length - 2] : value;
      const diff = value - prev;
      valorDisplay.style.color = diff > 0 ? getComputedStyle(document.documentElement).getPropertyValue('--chart-color').trim() || '#0b8a3e' : (diff < 0 ? 'var(--danger)' : 'var(--text)');
      adjustYAxisToPrice(value);
    }

    function clearActiveSelection(){ try{ chart.setActiveElements([]); chart.tooltip.setActiveElements([], {x:0,y:0}); chart.update('none'); }catch(e){} }
    function highlightPoint(index){
      if(index == null) return;
      clearActiveSelection();
      const active = [{datasetIndex:0, index}];
      chart.setActiveElements(active);
      const x = chart.scales.x.getPixelForValue(chart.data.labels[index]);
      const y = chart.scales.y.getPixelForValue(chart.data.datasets[0].data[index]);
      chart.tooltip.setActiveElements(active, {x,y});
      chart.update('none');
      const val = chart.data.datasets[0].data[index];
      valorDisplay.textContent = formatDynamicDecimals(Number(val)) + ' €';
    }
    window.highlightPoint = highlightPoint;

    let paused = false;
    let updateTimer = null;

    function pushNewMasterPoint(nextDate, newMasterVal){
      clearActiveSelection();
      masterLabels.push(nextDate);
      masterValues.push(newMasterVal);
      if(masterLabels.length > PRESET_POINTS){ masterLabels.shift(); masterValues.shift(); }

      const lastSmoothed = chart.data.datasets[0].data[chart.data.datasets[0].data.length - 1];
      const raw = newMasterVal + (Math.random() - 0.5) * 0.0008;
      const alpha = 0.10;
      let smoothed = lastSmoothed * (1 - alpha) + raw * alpha;

      const delta = smoothed - lastSmoothed;
      const limitedDelta = clamp(delta, -MAX_STEP_PER_TICK, MAX_STEP_PER_TICK);
      smoothed = clamp(lastSmoothed + limitedDelta, MIN, MAX);

      chart.data.labels.push(nextDate);
      chart.data.datasets[0].data.push(Number(smoothed.toFixed(6)));
      if(chart.data.labels.length > PRESET_POINTS){ chart.data.labels.shift(); chart.data.datasets[0].data.shift(); }
      chart.update('none');

      setTimeout(() => clearActiveSelection(), 20);
      updateMainDisplay(Number(chart.data.datasets[0].data[chart.data.datasets[0].data.length - 1]));
    }

    function scheduleNextUpdate(){
      if(updateTimer) clearInterval(updateTimer);
      updateTimer = setInterval(() => {
        if(paused) return;
        const lastLabel = masterLabels[masterLabels.length - 1];
        const lastTime = (lastLabel instanceof Date) ? lastLabel.getTime() : new Date(lastLabel).getTime();
        const nextTime = new Date(lastTime + UPDATE_INTERVAL_MS);
        const prev = masterValues[masterValues.length - 1];
        const nv = nextValue(prev);
        pushNewMasterPoint(nextTime, nv);
      }, UPDATE_INTERVAL_MS);
    }
    scheduleNextUpdate();
    updateMainDisplay(chart.data.datasets[0].data[chart.data.datasets[0].data.length - 1]);

    /* ---------------- Transactions (botones funcionales) ---------------- */
    function randomHex(len=8){ const chars='0123456789abcdef'; let s=''; for(let i=0;i<len;i++) s+=chars[Math.floor(Math.random()*chars.length)]; return s; }

    document.getElementById('btnEnviar').addEventListener('click', () => {
      const html = `
        <div class="modal-header"><h3>Enviar SchoolCoins</h3></div>
        <div class="modal-body">
          <div class="field"><label>Destinatario</label><input id="m_dest" type="text" placeholder="Dirección o usuario"></div>
          <div class="field"><label>Cantidad (SC)</label><input id="m_amt" type="number" step="0.0001" placeholder="0.01"></div>
          <div class="small-note">Referencia de cuenta: <strong>${accountCode}</strong></div>
          <div class="row-actions"><button class="btn-ghost" id="m_cancel">Cancelar</button><button class="btn-primary" id="m_send">Enviar</button></div>
        </div>`;
      const bd = openModal(html);
      bd.querySelector('#m_cancel').addEventListener('click', () => closeModal(bd));
      bd.querySelector('#m_send').addEventListener('click', () => {
        const dest = bd.querySelector('#m_dest').value || 'desconocido';
        const amt = parseFloat(bd.querySelector('#m_amt').value) || 0;
        const lastIndex = masterLabels.length - 1;
        TRANSACTIONS.push({ txid: randomHex(16), ref: accountCode, type:'envio', from:'you', to:dest, amount: Number(amt.toFixed(4)), timestamp: new Date(masterLabels[lastIndex]).toISOString(), index: lastIndex });
        const prev = masterValues[masterValues.length - 1];
        const impact = clamp(amt * 0.00002, 0, 0.003);
        const nv = clamp(prev + impact * (Math.random() > 0.5 ? 1 : -1), MIN, MAX);
        const nextTime = new Date(((masterLabels[lastIndex] instanceof Date) ? masterLabels[lastIndex].getTime() : new Date(masterLabels[lastIndex]).getTime()) + UPDATE_INTERVAL_MS);
        pushNewMasterPoint(nextTime, Number(nv.toFixed(6)));
        bd.querySelector('.modal').innerHTML = `<div class="modal-header"><h3>Enviado</h3></div><div class="modal-body"><div class="confirm-card"><div style="font-weight:800;margin-bottom:6px;">Enviado ${amt.toFixed(4)} SC</div><div class="muted">a ${dest}</div><div style="margin-top:8px;">Referencia: <strong>${accountCode}</strong></div></div><div class="row-actions" style="margin-top:12px;"><button class="btn-primary" id="m_ok">Aceptar</button></div></div>`;
        bd.querySelector('#m_ok').addEventListener('click', () => closeModal(bd));
      });
    });

    document.getElementById('btnIngresos').addEventListener('click', () => {
      const html = `
        <div class="modal-header"><h3>Registrar Ingreso</h3></div>
        <div class="modal-body">
          <div class="field"><label>Origen</label><input id="i_from" type="text" placeholder="Usuario o fuente"></div>
          <div class="field"><label>Cantidad (SC)</label><input id="i_amt" type="number" step="0.01" placeholder="10.00"></div>
          <div class="field"><label>Código de verificación del centro</label><input id="i_code" type="password" placeholder="Introduce el código (oculto)"></div>
          <div id="i_error" class="error" style="display:none;color:var(--danger);">Código incorrecto</div>
          <div class="small-note">Referencia de cuenta: <strong>${accountCode}</strong></div>
          <div class="row-actions"><button class="btn-ghost" id="i_cancel">Cancelar</button><button class="btn-primary" id="i_ok">Confirmar</button></div>
        </div>`;
      const bd = openModal(html);
      const CODE = 'IESJRCOIN';
      bd.querySelector('#i_cancel').addEventListener('click', () => closeModal(bd));
      bd.querySelector('#i_ok').addEventListener('click', () => {
        const from = bd.querySelector('#i_from').value || 'external';
        const amt = parseFloat(bd.querySelector('#i_amt').value) || 0;
        const code = bd.querySelector('#i_code').value || '';
        const errEl = bd.querySelector('#i_error');
        if(code !== CODE){ errEl.style.display = 'block'; return; }
        errEl.style.display = 'none';
        const lastIndex = masterLabels.length - 1;
        TRANSACTIONS.push({ txid: randomHex(16), ref: accountCode, type:'ingreso', from, to:'you', amount: Number(amt.toFixed(4)), timestamp: new Date(masterLabels[lastIndex]).toISOString(), index: lastIndex });
        const prev = masterValues[masterValues.length - 1];
        const nv = clamp(prev + clamp(amt * 0.00002, 0, 0.003), MIN, MAX);
        const nextTime = new Date(((masterLabels[lastIndex] instanceof Date) ? masterLabels[lastIndex].getTime() : new Date(masterLabels[lastIndex]).getTime()) + UPDATE_INTERVAL_MS);
        pushNewMasterPoint(nextTime, Number(nv.toFixed(6)));
        bd.querySelector('.modal').innerHTML = `<div class="modal-header"><h3>Ingreso registrado</h3></div><div class="modal-body"><div class="confirm-card"><div style="font-weight:800;margin-bottom:6px;">+${amt.toFixed(4)} SC</div><div class="muted">Origen: ${from}</div><div style="margin-top:8px;">Referencia: <strong>${accountCode}</strong></div></div><div class="row-actions" style="margin-top:12px;"><button class="btn-primary" id="i_done">Aceptar</button></div></div>`;
        bd.querySelector('#i_done').addEventListener('click', () => closeModal(bd));
      });
    });

    document.getElementById('btnCambiar').addEventListener('click', () => {
      const currentPrice = Number(chart.data.datasets[0].data[chart.data.datasets[0].data.length - 1]);
      const html = `
        <div class="modal-header"><h3>Cambiar SchoolCoins a €</h3></div>
        <div class="modal-body">
          <div class="field"><label>Cantidad (SC)</label><input id="c_amt" type="number" step="0.0001" placeholder="10.00"></div>
          <div class="field"><label>Precio por SC</label><div style="padding:10px;border-radius:10px;background:#fff;border:1px solid rgba(0,0,0,0.06);font-weight:800;">${formatDynamicDecimals(currentPrice)} €</div><div class="small-note">Equivalencia se calculará al confirmar y se guardará en la transacción.</div></div>
          <div class="small-note">Referencia de cuenta: <strong>${accountCode}</strong></div>
          <div class="row-actions"><button class="btn-ghost" id="c_cancel">Cancelar</button><button class="btn-primary" id="c_ok">Cambiar</button></div>
        </div>`;
      const bd = openModal(html);
      const input = bd.querySelector('#c_amt');
      bd.querySelector('#c_cancel').addEventListener('click', () => closeModal(bd));
      bd.querySelector('#c_ok').addEventListener('click', () => {
        const amt = parseFloat(input.value) || 0;
        if(amt <= 0){ input.focus(); return; }
        const lastIndex = masterLabels.length - 1;
        const priceNow = Number(chart.data.datasets[0].data[chart.data.datasets[0].data.length - 1]);
        const euros = Number((amt * priceNow).toFixed(6));
        TRANSACTIONS.push({ txid: randomHex(16), ref: accountCode, type:'cambio', from:'you', to:'exchange', amount: Number(amt.toFixed(4)), euro: euros, price_at: priceNow, timestamp: new Date(masterLabels[lastIndex]).toISOString(), index: lastIndex });
        const prev = masterValues[masterValues.length - 1];
        const nv = clamp(prev + (Math.random()-0.5) * 0.0008, MIN, MAX);
        const nextTime = new Date(((masterLabels[lastIndex] instanceof Date) ? masterLabels[lastIndex].getTime() : new Date(masterLabels[lastIndex]).getTime()) + UPDATE_INTERVAL_MS);
        pushNewMasterPoint(nextTime, Number(nv.toFixed(6)));
        bd.querySelector('.modal').innerHTML = `<div class="modal-header"><h3>Cambio realizado</h3></div><div class="modal-body"><div class="confirm-card"><div style="font-weight:800;margin-bottom:6px;">${amt.toFixed(4)} SC → ${euros.toFixed(6)} €</div><div class="muted">Precio usado: ${formatDynamicDecimals(priceNow)} €</div><div style="margin-top:8px;">Referencia: <strong>${accountCode}</strong></div></div><div class="row-actions" style="margin-top:12px;"><button class="btn-primary" id="c_done">Aceptar</button></div></div>`;
        bd.querySelector('#c_done').addEventListener('click', () => closeModal(bd));
      });
    });

    document.getElementById('btnCuenta').addEventListener('click', () => {
      const modalHtml = `
        <div class="modal-header"><h3>Mi cuenta</h3></div>
        <div class="modal-body" style="text-align:center;">
          <div style="font-size:13px;color:var(--muted);margin-bottom:8px;">Código de cuenta</div>
          <div style="display:inline-block;background:#fff;padding:12px 16px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);font-weight:900;font-size:18px;">
            ${accountCode}
          </div>
          <div style="margin-top:12px;color:var(--muted);font-size:13px;">Guarda este código para recibir ingresos.</div>
          <div style="display:flex;justify-content:center;margin-top:16px;">
            <button class="btn-primary" id="closeAccount">Cerrar</button>
          </div>
        </div>
      `;
      const bd = openModal(modalHtml);
      bd.querySelector('#closeAccount').addEventListener('click', () => closeModal(bd));
    });

    /* ---------------- Appearance presets & full-page background ---------------- */
    const PRESETS = [
      { id: 'sunny', name: 'Sunny Warm', bgPrimary: '#FFF7D6', bgSecondary: '#F7D54A', chart: '#0b8a3e' },
      { id: 'ocean', name: 'Ocean Breeze', bgPrimary: '#E6F7FF', bgSecondary: '#6EC1E4', chart: '#0a6fa0' },
      { id: 'lavender', name: 'Lavender', bgPrimary: '#F3E8FF', bgSecondary: '#CFA3FF', chart: '#6b3fa0' },
      { id: 'mint', name: 'Mint', bgPrimary: '#E9FFF4', bgSecondary: '#7FE3B2', chart: '#0a8a5a' },
      { id: 'slate', name: 'Slate', bgPrimary: '#F4F6F8', bgSecondary: '#C8D3DD', chart: '#2b4a5a' },
      { id: 'midnight', name: 'Midnight', bgPrimary: '#0f1724', bgSecondary: '#1f2a44', chart: '#7fb3ff' }
    ];

    function hexToRgb(hex) {
      const h = hex.replace('#','');
      const full = h.length === 3 ? h.split('').map(c=>c+c).join('') : h;
      const num = parseInt(full, 16);
      return { r: (num >> 16) & 255, g: (num >> 8) & 255, b: num & 255 };
    }
    function luminanceFromHex(hex) {
      const { r, g, b } = hexToRgb(hex);
      const srgb = [r,g,b].map(v => v/255).map(c => c <= 0.03928 ? c/12.92 : Math.pow((c+0.055)/1.055, 2.4));
      return 0.2126 * srgb[0] + 0.7152 * srgb[1] + 0.0722 * srgb[2];
    }
    function pickTextColorForBackground(primaryHex, secondaryHex) {
      const lum = (luminanceFromHex(primaryHex) + luminanceFromHex(secondaryHex)) / 2;
      return lum < 0.45 ? { text: '#ffffff', muted: 'rgba(255,255,255,0.8)' } : { text: '#0b0b0b', muted: '#444444' };
    }
    function hexToRgba(hex, alpha) {
      const h = hex.replace('#','');
      const full = h.length === 3 ? h.split('').map(c=>c+c).join('') : h;
      const num = parseInt(full, 16);
      const r = (num >> 16) & 255;
      const g = (num >> 8) & 255;
      const b = num & 255;
      return `rgba(${r},${g},${b},${alpha})`;
    }

    function applyPreset(preset) {
      const p = preset.bgPrimary;
      const s = preset.bgSecondary;
      document.documentElement.style.setProperty('--app-bg', p);
      document.documentElement.style.setProperty('--chart-color', preset.chart);
      document.body.style.background = `linear-gradient(180deg, ${p} 0%, ${s} 100%)`;
      document.body.style.backgroundSize = 'cover';
      document.body.style.backgroundPosition = 'center';
      document.body.style.backgroundAttachment = 'fixed';
      document.body.style.backgroundRepeat = 'no-repeat';
      const colors = pickTextColorForBackground(p, s);
      document.documentElement.style.setProperty('--text', colors.text);
      document.documentElement.style.setProperty('--muted', colors.muted);
      if (window.chartInstance && chartInstance.data && chartInstance.data.datasets && chartInstance.data.datasets[0]) {
        chartInstance.data.datasets[0].borderColor = preset.chart;
        chartInstance.data.datasets[0].backgroundColor = hexToRgba(preset.chart, 0.10);
        chartInstance.update('none');
      }
      document.querySelectorAll('.header, .small-note, .muted, .field label').forEach(el => {
        el.style.color = colors.text === '#ffffff' ? colors.text : 'var(--text)';
      });
    }

    const PRESET_KEY = 'schoolcoin_preset_choice';
    function savePresetChoice(id) { try { localStorage.setItem(PRESET_KEY, id); } catch(e){} }
    function loadPresetChoice() { try { const id = localStorage.getItem(PRESET_KEY); return PRESETS.find(p => p.id === id) || PRESETS[0]; } catch(e) { return PRESETS[0]; } }

    function openPresetModal() {
      const current = loadPresetChoice();
      let html = `<div class="modal-header"><h3>Apariencia</h3></div><div class="modal-body"><div style="display:flex;gap:12px;flex-wrap:wrap;">`;
      PRESETS.forEach(p => {
        const textColor = pickTextColorForBackground(p.bgPrimary,p.bgSecondary).text;
        html += `
          <button class="preset-card" data-id="${p.id}" style="flex:1 1 200px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);padding:12px;background:linear-gradient(180deg, ${p.bgPrimary}, ${p.bgSecondary});cursor:pointer;">
            <div style="font-weight:800;margin-bottom:8px;color:${textColor};">${p.name}</div>
            <div style="height:36px;border-radius:6px;background:${p.chart};"></div>
          </button>`;
      });
      html += `</div><div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;"><button class="btn-ghost" id="presetCancel">Cancelar</button><button class="btn-primary" id="presetSave">Guardar</button></div></div>`;

      const bd = openModal(html);
      bd.querySelectorAll('.preset-card').forEach(btn => {
        if (btn.dataset.id === current.id) btn.style.outline = '3px solid rgba(0,0,0,0.06)';
        btn.addEventListener('click', () => {
          bd.querySelectorAll('.preset-card').forEach(x => x.style.outline = '');
          btn.style.outline = '3px solid rgba(0,0,0,0.06)';
          bd._selected = PRESETS.find(p => p.id === btn.dataset.id);
          applyPreset(bd._selected);
        });
      });

      bd._selected = current;
      bd.querySelector('#presetCancel').addEventListener('click', () => closeModal(bd));
      bd.querySelector('#presetSave').addEventListener('click', () => {
        if (bd._selected) { savePresetChoice(bd._selected.id); applyPreset(bd._selected); }
        closeModal(bd);
      });
    }

    const settingsBtn = document.getElementById('settingsBtn');
    if (settingsBtn) settingsBtn.addEventListener('click', openPresetModal);

    (function(){ const p = loadPresetChoice(); applyPreset(p); })();

    /* ---------------- Info modal (question mark) ---------------- */
    const infoBtn = document.getElementById('infoBtn');
    infoBtn.addEventListener('click', () => {
      const content = `
        <div class="modal-header"><h3>Información sobre SchoolCoin</h3></div>
        <div class="modal-body info-content">

          <style>
            .accordion-item {
              border-bottom:1px solid rgba(0,0,0,0.08);
              padding:10px 0;
            }
            .accordion-title {
              font-weight:800;
              font-size:15px;
              cursor:pointer;
              display:flex;
              justify-content:space-between;
              align-items:center;
              color:var(--text);
            }
            .accordion-title span {
              font-size:18px;
              font-weight:900;
            }
            .accordion-content {
              display:none;
              margin-top:6px;
              color:var(--muted);
              line-height:1.45;
            }
          </style>

          <!-- 1 -->
          <div class="accordion-item">
            <div class="accordion-title">¿Qué es SchoolCoin? <span>+</span></div>
            <div class="accordion-content">
              SchoolCoin es una moneda digital creada para el entorno escolar. Sirve para premiar el esfuerzo, la participación y las buenas acciones dentro del instituto.
            </div>
          </div>

          <!-- 2 -->
          <div class="accordion-item">
            <div class="accordion-title">¿Para qué sirve? <span>+</span></div>
            <div class="accordion-content">
              Puedes usar SchoolCoin para obtener descuentos en la cafetería, participar en sorteos, conseguir material escolar o incluso obtener puntos extra en evaluaciones.
            </div>
          </div>

          <!-- 3 -->
          <div class="accordion-item">
            <div class="accordion-title">¿Por qué es segura? <span>+</span></div>
            <div class="accordion-content">
              SchoolCoin funciona con un sistema interno del centro educativo.  
              No depende de mercados externos, no puede perder valor por especulación  
              y todas las transacciones quedan registradas.  
              Además, cada usuario tiene un código único IESXXXXXXXX.
            </div>
          </div>

          <!-- 4 -->
          <div class="accordion-item">
            <div class="accordion-title">¿Por qué comprarla o usarla? <span>+</span></div>
            <div class="accordion-content">
              Porque te da acceso a ventajas exclusivas:  
              • Descuentos  
              • Sorteos  
              • Material escolar  
              • Actividades especiales  
              • Puntos extra  
              Y te familiariza con el uso de monedas digitales de forma segura.
            </div>
          </div>

          <!-- 5 -->
          <div class="accordion-item">
            <div class="accordion-title">Valor de SchoolCoin <span>+</span></div>
            <div class="accordion-content">
              <strong>Valor de entrada: 0,10 € (10 céntimos)</strong> por cada SchoolCoin.<br><br>
              SchoolCoin es una criptomoneda, por lo que su valor varía en tiempo real según la oferta y la demanda del mercado escolar.<br><br>
              • El precio fluctua constantemente (consulta la gráfica principal)<br>
              • Puedes cambiar tus SC a euros cuando el valor sea favorable<br>
              • El valor depende de la actividad y transacciones dentro del instituto<br>
              • Al igual que otras criptomonedas, su cotización cambia cada instante
            </div>
          </div>

          <!-- 6 -->
          <div class="accordion-item">
            <div class="accordion-title">¿En qué se puede usar? <span>+</span></div>
            <div class="accordion-content">
              • Descuentos en cafetería  
              • Material escolar  
              • Sorteos semanales  
              • Actividades especiales  
              • Puntos extra en asignaturas  
            </div>
          </div>
          <!-- 7 -->
          <div class="accordion-item">
            <div class="accordion-title">¿Dónde encontrarnos? <span>+</span></div>
            <div class="accordion-content">
              <strong>IES Joaquín Rodrigo</strong><br><br>
              <strong>Dirección:</strong><br>
              Calle Casalarreina, 28<br>
              28032 Madrid (Vicálvaro)<br><br>

              <strong>Contacto:</strong><br>
              • Teléfono: 91 776 22 62<br>
              • Fax: 91 776 23 93<br>
              • Email: ies.joaquinrodrigo.madrid@educa.madrid.org<br><br>

              <strong>Web:</strong><br>
              <a href="https://site.educa.madrid.org/ies.joaquinrodrigo.madrid/" target="_blank" style="color:var(--chart-color);">site.educa.madrid.org/ies.joaquinrodrigo.madrid</a>
            </div>
          </div>


          <div style="display:flex;justify-content:flex-end;margin-top:12px;">
            <button class="btn-primary" id="closeInfo">Cerrar</button>
          </div>
        </div>
      `;
      const bd = openModal(content);
      
      // Add accordion functionality after modal is created
      bd.querySelectorAll('.accordion-title').forEach(t => {
        t.addEventListener('click', () => {
          const accordionContent = t.nextElementSibling;
          const isOpen = accordionContent.style.display === 'block';
          
          // Close all
          bd.querySelectorAll('.accordion-content').forEach(c => c.style.display = 'none');
          bd.querySelectorAll('.accordion-title span').forEach(s => s.textContent = '+');
          
          // Open clicked if was closed
          if(!isOpen){
            accordionContent.style.display = 'block';
            t.querySelector('span').textContent = '-';
          }
        });
      });
      
      bd.querySelector('#closeInfo').addEventListener('click', () => closeModal(bd));
    });

    /* ---------------- Pause / add sample ---------------- */
    
    

    /* ---------------- Observe chart color var changes ---------------- */
    const observer = new MutationObserver(() => {
      const accent = getComputedStyle(document.documentElement).getPropertyValue('--chart-color').trim() || '#0b8a3e';
      chart.data.datasets[0].borderColor = accent;
      chart.data.datasets[0].backgroundColor = hexToRgba(accent, 0.10);
      chart.update('none');
    });
    observer.observe(document.documentElement, { attributes: true, attributeFilter: ['style'] });

  </script>
</body>
</html>