<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SCHOOLCOIN - Mi cuenta mejorada</title>

  <style>
    :root{
      --app-bg: #f7d54a;
      --accent: #0b8a3e;
      --muted: #666;
      --card-bg: #fff;
      --glass: rgba(255,255,255,0.9);
      --danger: #c62828;
      --radius: 12px;
      --shadow: 0 6px 18px rgba(0,0,0,0.08);
      --text: #222;
    }
    html,body{height:100%;margin:0;font-family:Inter,Arial,sans-serif;background:var(--app-bg);color:var(--text);}
    .contenedor{width:100%;max-width:420px;margin:0 auto;padding:16px;box-sizing:border-box;}
    .top-bar{background:#000;color:#fff;padding:10px;font-weight:700;text-align:center;border-radius:8px;}
    .header{margin-top:14px;font-size:22px;font-weight:800;text-align:center;}
    .chart-wrap{margin-top:14px;border-radius:12px;padding:6px;}
    canvas{width:100% !important;height:300px !important;display:block;border-radius:8px;}
    .botones{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px;}
    .boton{background:var(--accent);color:#fff;padding:12px;border-radius:10px;font-weight:700;text-align:center;cursor:pointer;user-select:none;box-shadow:var(--shadow);border:0;}
    .info-box{margin-top:12px;background:rgba(0,0,0,0.06);padding:10px;border-radius:8px;font-size:13px;}
    /* Modal y lista con tema de la app */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;}
    .modal{background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.95));color:var(--text);border-radius:16px;padding:14px;max-width:720px;width:100%;box-sizing:border-box;max-height:86vh;overflow:auto;box-shadow:var(--shadow);}
    .modal h3{margin:0 0 8px 0;font-size:18px;}
    .filters{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;}
    .filter-btn{padding:8px 10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);background:transparent;cursor:pointer;font-weight:700;color:var(--text);}
    .filter-active{background:var(--accent);color:#fff;border-color:var(--accent);}
    .tx-list{display:flex;flex-direction:column;gap:10px;padding:0;margin:0;}
    .tx-card{background:var(--card-bg);border-radius:12px;padding:10px;display:flex;justify-content:space-between;align-items:center;box-shadow:var(--shadow);cursor:pointer;border:1px solid rgba(0,0,0,0.04);}
    .tx-left{display:flex;flex-direction:column;gap:6px;min-width:0;}
    .tx-id{font-weight:800;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:180px;}
    .tx-meta{font-size:12px;color:var(--muted);display:flex;gap:8px;align-items:center;}
    .tx-amount{font-weight:900;color:var(--accent);min-width:90px;text-align:right;}
    .tx-type{font-size:11px;padding:4px 8px;border-radius:999px;background:rgba(11,138,62,0.08);color:var(--accent);font-weight:800;}
    .tx-type.gasto{background:rgba(198,40,40,0.08);color:var(--danger);}
    .tx-detail{margin-top:10px;background:linear-gradient(180deg,#fff,#fafafa);padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.04);font-size:13px;}
    .row{display:flex;gap:8px;align-items:center;}
    .btn-small{padding:8px 10px;border-radius:8px;border:0;background:var(--accent);color:#fff;cursor:pointer;font-weight:700;}
    .muted{color:var(--muted);font-size:13px;}
    .empty{padding:18px;text-align:center;color:var(--muted);background:rgba(255,255,255,0.6);border-radius:12px;}
    @media (max-width:420px){ .tx-id{max-width:120px;} canvas{height:240px !important;} }
  </style>
</head>
<body>
  <div class="contenedor">
    <div class="top-bar">SCHOOLCOIN</div>
    <div class="header">IES-SchoolCoin</div>

    <!-- Gráfica simplificada (placeholder) -->
    <div class="chart-wrap"><canvas id="grafica"></canvas></div>

    <div class="botones" style="margin-top:12px;">
      <div class="boton" id="btnEnviar">Enviar</div>
      <div class="boton" id="btnIngresos">Ingresos</div>
      <div class="boton" id="btnCambiar">Cambiar</div>
      <div class="boton" id="btnCuenta">Mi cuenta</div>
    </div>

    <div class="info-box">Toca una transacción para ver más detalles. Usa filtros para encontrar lo que buscas.</div>
  </div>

  <!-- Chart.js (mantener si ya lo usas) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <script>
    // Datos de ejemplo y utilidades (integra con tu lógica real)
    const TRANSACTIONS = []; // empieza vacío; se llenará al enviar/ingresar/cambiar
    function randomHex(len=8){ const chars='0123456789abcdef'; let s=''; for(let i=0;i<len;i++) s+=chars[Math.floor(Math.random()*chars.length)]; return s; }
    function formatDate(d){ return new Date(d).toLocaleString('es-ES', {year:'numeric',month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'}); }

    // Modal builder estilizado
    function openModal(contentHtml){
      const bd = document.createElement('div');
      bd.className = 'modal-backdrop';
      bd.innerHTML = `<div class="modal">${contentHtml}</div>`;
      document.body.appendChild(bd);
      bd.addEventListener('click', (e) => { if(e.target === bd) bd.remove(); });
      return bd;
    }
    function closeModal(bd){ if(bd && bd.remove) bd.remove(); }

    // Render simplificado de Mi cuenta
    document.getElementById('btnCuenta').addEventListener('click', () => {
      renderAccountModal('all', 0);
    });

    function renderAccountModal(filter='all', page=0){
      const PAGE_SIZE = 10;
      let filtered = TRANSACTIONS.slice();
      if(filter !== 'all') filtered = filtered.filter(t => t.type === filter);
      const total = filtered.length;
      const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      const start = page * PAGE_SIZE;
      const pageItems = filtered.slice().reverse().slice(start, start + PAGE_SIZE);

      const filtersHtml = `
        <div class="filters">
          <button class="filter-btn ${filter==='all'?'filter-active':''}" data-filter="all">Todos</button>
          <button class="filter-btn ${filter==='ingreso'?'filter-active':''}" data-filter="ingreso">Ingresos</button>
          <button class="filter-btn ${filter==='gasto'?'filter-active':''}" data-filter="gasto">Gastos</button>
          <button class="filter-btn ${filter==='envio'?'filter-active':''}" data-filter="envio">Envíos</button>
          <button class="filter-btn ${filter==='cambio'?'filter-active':''}" data-filter="cambio">Cambios</button>
        </div>`;

      let listHtml = '';
      if(pageItems.length === 0){
        listHtml = `<div class="empty">No hay transacciones que coincidan.</div>`;
      } else {
        listHtml = `<div class="tx-list">`;
        pageItems.forEach(tx => {
          const shortId = tx.txid.slice(0,10) + (tx.txid.length>10 ? '…' : '');
          const typeClass = tx.type === 'gasto' ? 'gasto' : '';
          const amountLabel = tx.type === 'cambio' ? `${Number(tx.amount).toFixed(4)} SC → ${Number(tx.euro).toFixed(4)} €` : `${Number(tx.amount).toFixed(4)} SC`;
          listHtml += `
            <div class="tx-card" data-txid="${tx.txid}">
              <div class="tx-left">
                <div class="tx-id">${shortId}</div>
                <div class="tx-meta"><span class="muted">${formatDate(tx.timestamp)}</span> · <span class="tx-type ${typeClass}">${tx.type}</span></div>
              </div>
              <div class="tx-amount">${amountLabel}</div>
            </div>`;
        });
        listHtml += `</div>`;
      }

      const pagerHtml = `
        <div style="display:flex;gap:8px;justify-content:center;margin-top:12px;">
          <button class="btn-small" id="prevPage" ${page===0?'disabled':''}>Anterior</button>
          <div style="align-self:center;color:var(--muted)">Página ${page+1} / ${totalPages}</div>
          <button class="btn-small" id="nextPage" ${page+1>=totalPages?'disabled':''}>Siguiente</button>
        </div>`;

      const modalHtml = `
        <h3>Mi cuenta</h3>
        ${filtersHtml}
        ${listHtml}
        ${pagerHtml}
        <div style="display:flex;justify-content:flex-end;margin-top:12px;"><button class="btn-small" id="closeAccount">Cerrar</button></div>
      `;

      const bd = openModal(modalHtml);

      // Handlers: filters
      bd.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const f = btn.getAttribute('data-filter');
          bd.remove();
          renderAccountModal(f, 0);
        });
      });

      // Pager
      const prev = bd.querySelector('#prevPage');
      const next = bd.querySelector('#nextPage');
      if(prev) prev.addEventListener('click', () => { bd.remove(); renderAccountModal(filter, Math.max(0, page-1)); });
      if(next) next.addEventListener('click', () => { bd.remove(); renderAccountModal(filter, page+1); });

      // Close
      bd.querySelector('#closeAccount').addEventListener('click', () => closeModal(bd));

      // Click en tarjeta: abrir detalle dentro del modal
      bd.querySelectorAll('.tx-card').forEach(card => {
        card.addEventListener('click', () => {
          const txid = card.getAttribute('data-txid');
          const tx = TRANSACTIONS.find(t => t.txid === txid);
          if(!tx) return;
          // detalle bonito
          const detailHtml = `
            <h3>Transacción</h3>
            <div class="tx-detail">
              <div style="font-weight:900;margin-bottom:8px;">${tx.txid}</div>
              <div class="muted">Tipo</div><div style="margin-bottom:8px;font-weight:700;">${tx.type}</div>
              <div class="muted">De</div><div style="margin-bottom:8px;">${tx.from}</div>
              <div class="muted">A</div><div style="margin-bottom:8px;">${tx.to}</div>
              <div class="muted">Cantidad</div><div style="margin-bottom:8px;font-weight:900;">${Number(tx.amount).toFixed(4)} SC ${tx.type==='cambio'?`→ ${Number(tx.euro).toFixed(4)} €`:''}</div>
              <div class="muted">Fecha</div><div style="margin-bottom:12px;">${new Date(tx.timestamp).toLocaleString('es-ES')}</div>
              <div style="display:flex;gap:8px;justify-content:flex-end;">
                <button class="btn-small" id="backList">Volver</button>
                <button class="btn-small" id="focusGraph">Ver en gráfica</button>
              </div>
            </div>
          `;
          bd.querySelector('.modal').innerHTML = detailHtml;
          bd.querySelector('#backList').addEventListener('click', () => { bd.remove(); renderAccountModal(filter, page); });
          bd.querySelector('#focusGraph').addEventListener('click', () => {
            // centrar en gráfica: resaltar punto si existe index
            if(typeof tx.index !== 'undefined' && window.highlightPoint) {
              window.highlightPoint(tx.index);
            }
          });
        });
      });
    }

    // Ejemplo: función global para resaltar punto en la gráfica (implementa en tu app)
    // Aquí definimos un stub para evitar errores si no existe la gráfica real.
    window.highlightPoint = function(index){
      // Si tienes Chart.js, implementa aquí la lógica para centrar y resaltar.
      console.log('Pedir resaltar punto', index);
      // Ejemplo: si usas chart variable:
      if(window.chartInstance && typeof window.chartInstance.setActiveElements === 'function'){
        const chart = window.chartInstance;
        chart.setActiveElements([{datasetIndex:0, index}]);
        chart.tooltip.setActiveElements([{datasetIndex:0, index}], {x:0,y:0});
        chart.update('none');
      }
    };

    // Para pruebas: añade algunas transacciones de ejemplo (puedes quitar esto)
    (function seedExample(){
      if(TRANSACTIONS.length) return;
      const now = Date.now();
      for(let i=0;i<8;i++){
        TRANSACTIONS.push({
          txid: randomHex(16),
          type: ['ingreso','envio','cambio','gasto'][i%4],
          from: i%2? 'user05' : 'external',
          to: i%2? 'you' : 'user12',
          amount: Number((1 + Math.random()*20).toFixed(4)),
          euro: i%4===2 ? Number((Math.random()*5).toFixed(4)) : undefined,
          timestamp: new Date(now - i*60000).toISOString(),
          index: Math.max(0, 590 + i) // índice aproximado para centrar en gráfica
        });
      }
    })();

    // Si quieres, integra aquí la creación real de la gráfica y asigna window.chartInstance
    // para que highlightPoint funcione correctamente.
  </script>
</body>
</html>