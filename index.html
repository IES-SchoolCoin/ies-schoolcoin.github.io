<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SCHOOLCOIN - Tiempo real simulado</title>

  <style>
    :root{
      --bg: #f7d54a;
      --top: #000;
      --btn: #8b5e3c;
      --text: #222;
    }

    html,body{height:100%; margin:0; font-family:Inter, Arial, sans-serif; background:var(--bg); color:var(--text);}
    .contenedor{
      width:100%;
      max-width:420px;
      margin:0 auto;
      padding:16px;
      box-sizing:border-box;
    }

    .top-bar{background:var(--top); color:#fff; padding:10px; font-weight:700; text-align:center; border-radius:8px;}
    .header{margin-top:14px; font-size:22px; font-weight:800; text-align:center;}
    .coin-logo{width:96px; height:96px; margin:14px auto;}
    .coin-logo img{width:100%; height:100%; object-fit:contain; display:block;}

    .valor-actual{font-size:30px; font-weight:800; margin-top:8px;}
    .meta-line{display:flex; justify-content:space-between; align-items:center; gap:8px; margin-top:6px; font-size:13px; color:#333;}

    .chart-wrap{width:100%; margin-top:14px; background:transparent; border-radius:12px; padding:6px 6px 2px 6px;}
    canvas{width:100% !important; height:220px !important; display:block;}

    .botones{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:16px;}
    .boton{background:var(--btn); color:#fff; padding:12px; border-radius:10px; font-weight:700; text-align:center; cursor:pointer; user-select:none;}

    .info-box{margin-top:12px; background:rgba(0,0,0,0.06); padding:10px; border-radius:8px; font-size:13px;}
    .controls{display:flex; gap:8px; margin-top:10px; justify-content:center;}
    .control-btn{background:#fff; border:1px solid #ccc; padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:600;}

    @media (max-width:400px){
      .botones{grid-template-columns:1fr;}
      canvas{height:200px !important;}
    }
  </style>
</head>
<body>
  <div class="contenedor">
    <div class="top-bar">SCHOOLCOIN</div>
    <div class="header">IES-SchoolCoin</div>

    <div class="coin-logo">
      <img src="LOGO.png" alt="Logo SCHOOLCOIN">
    </div>

    <div class="valor-actual" id="valorActual">0.00 €</div>
    <div class="meta-line">
      <div id="trendText">—</div>
      <div id="timestamp">—</div>
    </div>

    <div class="chart-wrap">
      <canvas id="grafica"></canvas>
    </div>

    <div class="botones">
      <div class="boton" id="btnEnviar">Enviar</div>
      <div class="boton" id="btnIngresos">Ingresos</div>
      <div class="boton" id="btnGastos">Gastos</div>
      <div class="boton" id="btnCuenta">Mi cuenta</div>
    </div>

    <div class="controls">
      <button class="control-btn" id="pauseBtn">Pausar actualizaciones</button>
      <button class="control-btn" id="addSample">Añadir valor ahora</button>
    </div>

    <div class="info-box" id="infoBox">
      Haz clic en un punto de la gráfica para ver su fecha y valor aquí.
    </div>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // ---------- CONFIGURACIÓN ----------
    const UPDATE_INTERVAL_MS = 2 * 60 * 1000; // 2 minutos
    const PRESET_POINTS = 60; // cuantos puntos preestablecidos (60 * 2min = 120min historial)
    const BASE = 0.175; // valor base en euros (17.5 cents)
    const MIN = 0.15;
    const MAX = 0.20;

    // ---------- UTILIDADES ----------
    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }
    function formatMoney(v){ return Number(v).toFixed(2) + ' €'; }
    function formatDate(d){
      return d.toLocaleString('es-ES', {year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit'});
    }

    // Genera un valor nuevo siguiendo un patrón de "random walk" alrededor de BASE
    function nextValue(prev){
      // paso aleatorio pequeño, con tendencia a volver a BASE
      const meanReversion = (BASE - prev) * 0.05; // tira hacia BASE
      const noise = (Math.random() - 0.5) * 0.01; // ruido +/- 0.005
      let v = prev + meanReversion + noise;
      v = clamp(v, MIN, MAX);
      return Number(v.toFixed(4));
    }

    // Genera etiquetas de tiempo espaciadas 2 minutos hacia atrás
    function generateInitialSeries(){
      const labels = [];
      const data = [];
      const now = Date.now();
      // empezamos PRESET_POINTS * 2min atrás
      const start = now - (PRESET_POINTS - 1) * UPDATE_INTERVAL_MS;
      let val = BASE + (Math.random() - 0.5) * 0.01; // valor inicial cercano a BASE
      for(let i=0;i<PRESET_POINTS;i++){
        const t = new Date(start + i * UPDATE_INTERVAL_MS);
        labels.push(t);
        // simular varios pasos para dar variación
        val = nextValue(val);
        data.push(Number(val.toFixed(4)));
      }
      return {labels, data};
    }

    // ---------- INICIALIZACIÓN DE DATOS ----------
    const initial = generateInitialSeries();
    const labels = initial.labels.slice(); // array de Date
    const values = initial.data.slice();

    // ---------- ACTUALIZAR UI ----------
    const valorActualEl = document.getElementById('valorActual');
    const timestampEl = document.getElementById('timestamp');
    const trendTextEl = document.getElementById('trendText');
    const infoBox = document.getElementById('infoBox');

    function updateMainDisplay(value, date){
      valorActualEl.textContent = formatMoney(value);
      timestampEl.textContent = formatDate(date);
      // tendencia: comparar con anterior
      const prev = values.length > 1 ? values[values.length - 2] : value;
      const diff = value - prev;
      const arrow = diff > 0 ? '▲' : (diff < 0 ? '▼' : '—');
      const pct = prev ? ((diff / prev) * 100).toFixed(2) + '%' : '';
      trendTextEl.textContent = arrow + ' ' + pct;
    }

    // ---------- CREAR GRÁFICA ----------
    const ctx = document.getElementById('grafica').getContext('2d');

    const chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels, // Date objects
        datasets: [{
          label: 'SCHOOLCOIN',
          data: values,
          borderColor: '#0b8a3e',
          backgroundColor: 'rgba(11,138,62,0.08)',
          pointRadius: 4,
          pointHoverRadius: 6,
          tension: 0.25,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'nearest',
          intersect: false
        },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(context){
                const v = Number(context.parsed.y).toFixed(4);
                const date = context.label instanceof Date ? formatDate(context.label) : context.label;
                return ` ${v} € — ${date}`;
              }
            }
          }
        },
        scales: {
          x: {
            type: 'time',
            time: {
              unit: 'minute',
              displayFormats: { minute: 'HH:mm' }
            },
            grid: { display: false }, // QUITAR CUADRÍCULA X
            ticks: { color: '#333' }
          },
          y: {
            beginAtZero: false,
            suggestedMin: MIN - 0.01,
            suggestedMax: MAX + 0.01,
            grid: { display: false }, // QUITAR CUADRÍCULA Y
            ticks: {
              callback: function(val){ return Number(val).toFixed(2) + ' €'; },
              color: '#333'
            }
          }
        },
        onClick: (evt, elements) => {
          if(elements.length){
            const el = elements[0];
            const idx = el.index;
            const val = chart.data.datasets[0].data[idx];
            const lab = chart.data.labels[idx];
            infoBox.textContent = `Punto: ${Number(val).toFixed(4)} € — ${formatDate(new Date(lab))}`;
          }
        }
      }
    });

    // Inicializar display con último punto
    updateMainDisplay(values[values.length - 1], new Date(labels[labels.length - 1]));

    // ---------- LÓGICA DE ACTUALIZACIÓN CADA 2 MINUTOS ----------
    let paused = false;
    let updateTimer = null;

    function pushNewPoint(nowDate, newVal){
      // añadir al final y eliminar el primero para mantener longitud
      chart.data.labels.push(nowDate);
      chart.data.datasets[0].data.push(newVal);
      if(chart.data.labels.length > PRESET_POINTS){
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
      }
      chart.update('active'); // animado
      // actualizar arrays locales
      labels.push(nowDate);
      values.push(newVal);
      if(labels.length > PRESET_POINTS){ labels.shift(); values.shift(); }
      updateMainDisplay(newVal, nowDate);
    }

    function scheduleNextUpdate(){
      if(updateTimer) clearInterval(updateTimer);
      updateTimer = setInterval(() => {
        if(paused) return;
        const prev = Number(chart.data.datasets[0].data[chart.data.datasets[0].data.length - 1]);
        const nv = nextValue(prev);
        const now = new Date();
        pushNewPoint(now, nv);
      }, UPDATE_INTERVAL_MS);
    }

    // arrancar el timer
    scheduleNextUpdate();

    // botón pausar / reanudar
    const pauseBtn = document.getElementById('pauseBtn');
    pauseBtn.addEventListener('click', () => {
      paused = !paused;
      pauseBtn.textContent = paused ? 'Reanudar actualizaciones' : 'Pausar actualizaciones';
    });

    // botón añadir valor ahora (útil para pruebas)
    document.getElementById('addSample').addEventListener('click', () => {
      const prev = Number(chart.data.datasets[0].data[chart.data.datasets[0].data.length - 1]);
      const nv = nextValue(prev);
      pushNewPoint(new Date(), nv);
    });

    // actualizar reloj en la UI cada segundo (solo la hora actual)
    setInterval(() => {
      const now = new Date();
      // solo actualizar la parte de segundos en timestamp si quieres mostrar en tiempo real
      // aquí mantenemos timestamp del último valor, pero también mostramos reloj en infoBox si se desea
      // no tocamos timestamp principal para que muestre la hora del último valor recibido
    }, 1000);

    // Si quieres que la gráfica sea "draggable" o zoomable, se puede añadir Chart.js Zoom plugin más adelante.
  </script>
</body>
</html>